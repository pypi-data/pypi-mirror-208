"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_views_starfish_components_chartPanel_tsx-app_views_starfish_modules_databaseModule_databa-e2ae20"],{"./app/utils/useKeyPress.tsx":(e,t,n)=>{n.d(t,{Z:()=>i});var a=n("../node_modules/react/index.js");const i=(e,t)=>{const[n,i]=(0,a.useState)(!1),s=t??document.body;return(0,a.useEffect)((()=>{const t=t=>{let{key:n}=t;n===e&&i(!0)},n=t=>{let{key:n}=t;n===e&&i(!1)};return s.addEventListener("keydown",t),s.addEventListener("keyup",n),()=>{s.removeEventListener("keydown",t),s.removeEventListener("keyup",n)}}),[e,s]),n}},"./app/utils/useOnClickOutside.tsx":(e,t,n)=>{n.d(t,{Z:()=>i});var a=n("../node_modules/react/index.js");const i=function(e,t){(0,a.useEffect)((()=>{const n=n=>{const a=e?.current;a&&!a.contains(n.target)&&t(n)};return document.addEventListener("mousedown",n),document.addEventListener("touchstart",n),()=>{document.removeEventListener("mousedown",n),document.removeEventListener("touchstart",n)}}),[e,t])}},"./app/views/starfish/components/chartPanel.tsx":(e,t,n)=>{n.d(t,{Z:()=>o});var a=n("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),i=(n("../node_modules/react/index.js"),n("./app/components/panels/index.tsx")),s=n("./app/styles/space.tsx"),r=n("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function o(e){let{title:t,children:n,button:a}=e;return(0,r.tZ)(i.s_,{children:(0,r.BX)(i.N,{withPadding:!0,children:[(0,r.BX)(l,{children:[t&&(0,r.tZ)(d,{children:t}),a]}),n]})})}o.displayName="ChartPanel";const d=(0,a.Z)("p",{target:"e1tvnfsq1"})((e=>e.theme.text.cardTitle),";"),l=(0,a.Z)("div",{target:"e1tvnfsq0"})("padding:0 ",(0,s.D)(1)," 0 0;min-height:36px;width:100%;display:flex;align-items:center;justify-content:space-between;")},"./app/views/starfish/components/detailPanel.tsx":(e,t,n)=>{n.d(t,{Z:()=>x});var a=n("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),i=n("../node_modules/react/index.js"),s=n("./app/components/button.tsx"),r=n("./app/icons/iconClose.tsx"),o=n("./app/locale.tsx"),d=n("./app/styles/space.tsx"),l=n("./app/utils/useKeyPress.tsx"),c=n("./app/utils/useOnClickOutside.tsx"),p=n("../node_modules/@emotion/is-prop-valid/dist/is-prop-valid.browser.esm.js"),m=n("../node_modules/framer-motion/dist/es/render/dom/motion.mjs"),u=n("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const h="50vw",f=(0,i.forwardRef)(y);function y(e,t){let{collapsed:n,children:a}=e;return(0,u.tZ)(g,{ref:t,collapsed:n,initial:{opacity:0,x:h},animate:n?{opacity:0,x:h}:{opacity:1,x:0},transition:{type:"spring",stiffness:500,damping:50},children:a})}y.displayName="SlideOverPanel";const g=(0,a.Z)(m.E.div,{shouldForwardProp:e=>["animate","transition"].includes(e)||"collapsed"!==e&&(0,p.Z)(e),target:"e1iwvxg00"})("width:",h,";position:fixed;top:0;bottom:0;right:0;background:",(e=>e.theme.background),";color:",(e=>e.theme.textColor),";border-left:1px solid ",(e=>e.theme.border),";text-align:left;z-index:",(e=>e.theme.zIndex.sidebar-1),";",(e=>e.collapsed?"overflow: hidden;":"overflow-x: hidden;\n  overflow-y: scroll;"),";");function x(e){let{children:t,detailKey:n,onClose:a}=e;const[s,d]=(0,i.useState)({collapsed:!0}),p=(0,l.Z)("Escape");(0,i.useEffect)((()=>{n&&d({collapsed:!1})}),[n]);const m=(0,i.useRef)(null);return(0,c.Z)(m,(()=>{s.collapsed||(a?.(),d({collapsed:!0}))})),(0,i.useEffect)((()=>{p&&(s.collapsed||(a?.(),d({collapsed:!0})))}),[p]),(0,u.BX)(f,{collapsed:s.collapsed,ref:m,children:[(0,u.tZ)(Z,{children:(0,u.tZ)(v,{priority:"link",size:"zero",borderless:!0,"aria-label":(0,o.t)("Close Details"),icon:(0,u.tZ)(r.b,{size:"sm"}),onClick:()=>{d({collapsed:!0}),a?.()}})}),(0,u.tZ)(_,{children:t})]})}x.displayName="Detail";const v=(0,a.Z)(s.zx,{target:"e1clb2dw2"})("color:",(e=>e.theme.gray300),";&:hover{color:",(e=>e.theme.gray400),";}"),Z=(0,a.Z)("div",{target:"e1clb2dw1"})("justify-content:flex-end;display:flex;padding:",(0,d.D)(2),";"),_=(0,a.Z)("div",{target:"e1clb2dw0"})("padding:0 ",(0,d.D)(4),";")},"./app/views/starfish/modules/databaseModule/databaseTableView.tsx":(e,t,n)=>{n.d(t,{Z:()=>x,h:()=>y});var a=n("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),i=n("../node_modules/react/index.js"),s=n("./app/components/badge.tsx"),r=n("./app/components/gridEditable/index.tsx"),o=n("./app/components/hovercard.tsx"),d=n("./app/components/links/link.tsx"),l=n("./app/constants/chartPalette.tsx"),c=n("./app/styles/space.tsx"),p=n("./app/views/starfish/components/sparkline.tsx"),m=n("./app/views/starfish/modules/databaseModule/panel/queryTransactionTable.tsx"),u=n("./app/views/starfish/modules/databaseModule/panel/index.tsx"),h=n("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const f=[{key:"description",name:"Query",width:600},{key:"domain",name:"Table",width:200},{key:"throughput",name:"Throughput",width:200},{key:"p75_trend",name:"P75 Trend",width:200},{key:"epm",name:"Tpm"},{key:"p75",name:"p75"},{key:"transactions",name:"transactions"},{key:"total_time",name:"Total Time"}];function y(e,t){if(e===t||void 0===t||void 0===e)return-1;const n=e.length<t.length?e.split(" "):t.split(" "),a=e.length>t.length?e.split(" "):t.split(" "),i=a.length;let s=0;for(;a.length>0;){const e=a.pop();e&&n.includes(e)&&(s+=1,n.splice(n.indexOf(e),1))}return s/i}function g(e,t){const n=y(t?.description,e.description)>.8,a=1===e?.newish,i=1===e?.retired;let s=null;return n?s=a&&1!==t.newish?(0,h.BX)("span",{children:[(0,h.tZ)(v,{type:"new",text:"new"}),(0,h.tZ)(v,{type:"alpha",text:"similar"})]}):i&&1!==t.retired?(0,h.BX)("span",{children:[(0,h.tZ)(v,{type:"warning",text:"old"}),(0,h.tZ)(v,{type:"alpha",text:"similar"})]}):(0,h.tZ)(v,{type:"alpha",text:"similar"}):a?s=(0,h.tZ)(v,{type:"new",text:"new"}):i&&(s=(0,h.tZ)(v,{type:"warning",text:"old"})),s}function x(e){let{location:t,data:n,onSelect:a,onSortChange:s,selectedRow:c,isDataLoading:y,columns:x}=e;const[v,Z]=(0,i.useState)({direction:void 0,sortHeader:void 0});return(0,h.tZ)(r.ZP,{isLoading:y,data:n,columnOrder:x??f,columnSortBy:[],grid:{renderHeadCell:function(e){if(["p75","epm","total_time","domain","transactions"].includes(e.key)){const t=e.key===v.sortHeader?.key?v.direction:void 0;return(0,h.tZ)(m.U,{onClick:()=>function(e){let t;v.direction&&e.key===v.sortHeader?.key?"desc"===v.direction&&(t="asc"):t="desc",s&&(Z({direction:t,sortHeader:e}),s({direction:t,sortHeader:e}))}(e),direction:t,title:e.name})}return(0,h.tZ)("span",{children:e.name})},renderBodyCell:function(e,t,n){const{key:i}=e,s=c?.group_id===t.group_id?{fontWeight:"bold"}:void 0,r=t[i];if("description"===i){let e="";return 1===t.newish?e=`Query (First seen ${t.firstSeen})`:1===t.retired&&(e=`Query (Last seen ${t.lastSeen})`),(0,h.BX)(o.uI,{header:e,body:(0,u._)(t.formatted_desc,t),children:[(0,h.BX)(d.Z,{onClick:()=>a(t,n),to:"",style:s,children:[r.substring(0,30),r.length>30?"...":"",r.length>30?r.substring(r.length-30):""]}),g(t,c)]})}return"p75"===i||"total_time"===i?(0,h.BX)("span",{style:s,children:[r.toFixed(2),"ms"]}):"throughput"===i?(0,h.tZ)(p.Z,{color:l.$[3][0],series:r,width:e.width?e.width-e.width/5:void 0}):"p75_trend"===i?(0,h.tZ)(p.Z,{color:l.$[3][3],series:r,width:e.width?e.width-e.width/5:void 0}):(0,h.tZ)("span",{style:s,children:r})}},location:t})}x.displayName="DatabaseTableView";const v=(0,a.Z)(s.Z,{target:"eejlxta0"})("margin-left:",(0,c.D)(.75),";")},"./app/views/starfish/modules/databaseModule/panel/index.tsx":(e,t,n)=>{n.d(t,{Z:()=>I,_:()=>z});var a=n("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),i=(n("../node_modules/core-js/modules/es.array.push.js"),n("../node_modules/react/index.js")),s=n("../node_modules/@emotion/react/dist/emotion-element-6a883da9.browser.esm.js"),r=n("../node_modules/lodash/keyBy.js"),o=n.n(r),d=n("../node_modules/moment/moment.js"),l=n.n(d),c=n("./app/components/badge.tsx"),p=n("./app/components/button.tsx"),m=n("./app/components/buttonBar.tsx"),u=n("./app/components/charts/components/markLine.tsx"),h=n("./app/components/timeSince.tsx"),f=n("./app/components/version.tsx"),y=n("./app/components/versionHoverCard.tsx"),g=n("./app/icons/index.tsx"),x=n("./app/locale.tsx"),v=n("./app/styles/space.tsx"),Z=n("./app/utils/useOrganization.tsx"),_=n("./app/utils/usePageFilters.tsx"),b=n("./app/views/starfish/components/chart.tsx"),w=n("./app/views/starfish/components/detailPanel.tsx"),$=n("./app/components/events/interfaces/spans/spanProfileDetails.tsx"),D=n("./app/components/loadingIndicator.tsx"),E=n("./app/views/profiling/profileGroupProvider.tsx"),T=n("./app/views/profiling/profilesProvider.tsx"),S=n("./app/views/starfish/modules/databaseModule/queries.ts"),k=n("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function q(e){const{spanHash:t,transactionNames:n}=e,a=(0,Z.Z)(),[s,r]=(0,i.useState)(0),o=(0,S.uw)(n),d=o?.data?.data?.map((e=>e.id))??[],l=(0,S.Ep)(d[s]);if(o.isLoading||l.isLoading||l.isRefetching)return(0,k.tZ)(D.Z,{});const c=()=>{r(s+1)};if(l.data.id&&s<d.length){const e=l.data,n=e.entries[0].data.find((e=>e.hash===t)),i=e.contexts?.profile?.profile_id??void 0;if(n&&i)return(0,k.tZ)(T.ProfilesProvider,{orgSlug:a.slug,profileId:i,projectSlug:"sentry",children:(0,k.tZ)(T.ProfileContext.Consumer,{children:t=>(0,k.tZ)(E.D,{type:"flamechart",input:"resolved"===t?.type?t.data:null,traceID:i||"",children:(0,k.tZ)($.O,{onNoProfileFound:c,event:e,span:n})})})});c()}return(0,k.tZ)(i.Fragment,{children:"'No profile found'"})}q.displayName="ProfileView";const j=q;var L=n("./app/views/starfish/modules/databaseModule/panel/queryTransactionTable.tsx"),M=n("./app/components/gridEditable/index.tsx"),R=n("./app/utils/useLocation.tsx"),N=n("./app/views/starfish/modules/databaseModule/databaseTableView.tsx");const C=[{key:"description",name:"Query",width:300},{key:"epm",name:"Tpm"},{key:"p75",name:"p75"},{key:"total_time",name:"Total Time"}];function B(e){const{mainTableRow:t}=e,{isLoading:n,data:a}=(0,S.$R)({limit:410}),r=(0,R.T)(),o=(0,s.u)(),d=a.filter((e=>(0,N.h)(e.description,t.description)>.8));return!n&&d.length>0?(0,k.tZ)(M.ZP,{isLoading:n,data:d,columnOrder:C,columnSortBy:[],grid:{renderHeadCell:e=>(0,k.tZ)("span",{children:e.name}),renderBodyCell:(e,n)=>{const{key:a}=e;let s=n[a];if("description"===a){const e=new Set(t.description.split(" "));s=(0,k.tZ)("div",{children:n.description.split(" ").map((t=>e.has(t)?`${t} `:(0,k.tZ)("span",{style:{color:o.green400},children:`${t} `},t)))})}if("epm"===a||"p75"===a||"total_time"===a){const e=n[a],r=e>t[a]?"+":"",d=100*(e/t[a]-1);let l="";"p75"!==a&&"total_time"!==a||(l="ms"),s=(0,k.BX)(i.Fragment,{children:[e.toFixed(3),l," (",r,(0,k.BX)("span",{style:{color:r?o.red400:o.green400},children:[d.toFixed(2),"%"]}),")"]})}return(0,k.tZ)("span",{children:s})}},location:r}):(0,k.tZ)(i.Fragment,{})}B.displayName="SimilarQueryView";const O=B;var P=n("./app/views/starfish/modules/databaseModule/utils.ts"),Y=n("./app/views/starfish/utils/dates.tsx"),F=n("./app/views/starfish/utils/zeroFillSeries.tsx");const H=12,A=24;function I(e){let{row:t,nextRow:n,prevRow:a,isDataLoading:i,onClose:s,onRowChange:r,mainTableSort:o,transaction:d}=e;return(0,k.tZ)(w.Z,{detailKey:t?.description,onClose:s,children:t&&(0,k.tZ)(X,{mainTableSort:o,onRowChange:r,isDataLoading:i,row:t,nextRow:n,prevRow:a,transaction:d})})}function X(e){let{row:t,nextRow:n,prevRow:a,onRowChange:r,transaction:d,isDataLoading:p}=e;const m=(0,s.u)(),u=(0,_.Z)(),g=(0,Z.Z)(),{startTime:v,endTime:w}=(0,Y.tZ)(u),$=1===t.newish,D=1===t.retired,[E,T]=(0,i.useState)({direction:void 0,sortHeader:void 0}),{isLoading:q,data:M}=(0,S.gy)(t,H),{isLoading:R,data:N}=(0,S.c0)(t,E.sortHeader?.key,E.direction,d),{isLoading:C,data:B}=(0,S.W3)(t,E.sortHeader?.key,E.direction,A,d),{isLoading:F,data:I}=(0,S.sE)(N.map((e=>e.transaction)).splice(0,5),A),{isLoading:X,data:te}=(0,S.Yy)(t),{isLoading:ne,data:ae}=(0,S.mi)(t),{isLoading:ie,data:se}=(0,S.Ep)(ae?.[0]?.first),{isLoading:re,data:oe}=(0,S.Ep)(ae?.[0]?.latest),de=q||R||X||p||F||ne||ie||re||C,le=o()(te,"transaction"),ce=N.map((e=>{const t=e.transaction,n=le[t];if(n?.uniqueEvents){const t=e.count/n.uniqueEvents;return{...e,frequency:t,...n}}return e})),[pe,me]=K(M,v,w),ue=(0,P.F)(B,"transaction","spm",v,w,A),he=(0,P.F)(B,"transaction","p50",v,w,A),fe=(0,P.F)(I,"group","epm()",v,w,A),ye=(0,P.F)(I,"group","p50(transaction.duration)",v,w,A),ge=ue?.[0]?.data&&($||D)?W($?"First Seen":"Last Seen",$?t.firstSeen:t.lastSeen,ue[0].data,m):void 0;return(0,k.BX)("div",{children:[(0,k.BX)(G,{children:[(0,k.tZ)(J,{children:(0,k.tZ)("h2",{children:(0,x.t)("Query Detail")})}),(0,k.tZ)(J,{children:(0,k.tZ)(Q,{disableLeft:!a,disableRight:!n,onLeftClick:()=>r(a),onRightClick:()=>r(n)})})]}),(0,k.BX)(G,{children:[(0,k.BX)(J,{children:[(0,k.BX)(U,{children:[(0,x.t)("First Seen"),1===t.newish&&(0,k.tZ)(c.Z,{type:"new",text:"new"})]}),Math.abs(l()(t.firstSeen).diff(v,"minutes"))<360?(0,k.BX)(V,{children:["More than ",(0,k.tZ)(h.Z,{date:t.firstSeen})," "]}):(0,k.BX)("span",{children:[(0,k.BX)(V,{children:[(0,k.tZ)(h.Z,{date:t.firstSeen})," "]}),se?.release&&(0,k.tZ)(y.ZP,{organization:g,projectSlug:"sentry",releaseVersion:se.release.version,showUnderline:!0,underlineColor:"linkUnderline",children:(0,k.tZ)(f.Z,{version:String(se.release.version),truncate:!0})})]})]}),(0,k.BX)(J,{children:[(0,k.BX)(U,{children:[(0,x.t)("Last Seen"),1===t.retired&&(0,k.tZ)(c.Z,{type:"warning",text:"old"})]}),(0,k.tZ)(V,{children:(0,k.tZ)(h.Z,{date:t.lastSeen})}),oe?.release&&(0,k.tZ)(y.ZP,{organization:g,projectSlug:"sentry",releaseVersion:oe.release.version,showUnderline:!0,underlineColor:"linkUnderline",children:(0,k.tZ)(f.Z,{version:String(oe.release.version),truncate:!0})})]}),(0,k.BX)(J,{children:[(0,k.tZ)(U,{children:(0,x.t)("Total Time")}),(0,k.BX)(V,{children:[t.total_time.toFixed(2),"ms"]})]})]}),(0,k.tZ)(U,{children:(0,x.t)("Query Description")}),(0,k.tZ)(ee,{children:z(t.formatted_desc,t)}),(0,k.BX)(G,{children:[(0,k.BX)(J,{children:[(0,k.tZ)(U,{children:(0,x.t)("Throughput")}),(0,k.tZ)(V,{children:t.epm.toFixed(3)}),(0,k.tZ)(b.Z,{statsPeriod:"24h",height:140,data:[pe],start:"",end:"",loading:de,utc:!1,stacked:!0,isLineChart:!0,disableXAxis:!0,hideYAxisSplitLine:!0})]}),(0,k.BX)(J,{children:[(0,k.tZ)(U,{children:(0,x.t)("Duration (P75)")}),(0,k.BX)(V,{children:[t.p75.toFixed(3),"ms"]}),(0,k.tZ)(b.Z,{statsPeriod:"24h",height:140,data:[me],start:"",end:"",loading:de,utc:!1,chartColors:[m.charts.getColorPalette(4)[3]],stacked:!0,isLineChart:!0,disableXAxis:!0,hideYAxisSplitLine:!0})]})]}),(0,k.tZ)(L.Z,{isDataLoading:de,onClickSort:e=>T(e),row:t,sort:E,tableData:ce,spmData:ue,tpmData:fe,spanP50Data:he,txnP50Data:ye,markLine:ge}),(0,k.tZ)(G,{children:(0,k.BX)(J,{children:[(0,k.tZ)(U,{children:(0,x.t)("Example Profile")}),(0,k.tZ)(j,{spanHash:t.group_id,transactionNames:N.map((e=>e.transaction))})]})}),(0,k.tZ)(G,{children:(0,k.BX)(J,{children:[(0,k.tZ)(U,{children:(0,x.t)("Similar Queries")}),(0,k.tZ)(O,{mainTableRow:t})]})})]})}function Q(e){return(0,k.BX)(m.ZP,{merged:!0,children:[(0,k.tZ)(p.zx,{icon:(0,k.tZ)(g.g6,{direction:"left",size:"sm"}),"aria-label":(0,x.t)("Previous"),disabled:e.disableLeft,onClick:e.onLeftClick}),(0,k.tZ)(p.zx,{icon:(0,k.tZ)(g.g6,{direction:"right",size:"sm"}),"aria-label":(0,x.t)("Next"),onClick:e.onRightClick,disabled:e.disableRight})]})}I.displayName="QueryDetail",X.displayName="QueryDetailBody",Q.displayName="SimplePagination";const z=(e,t)=>{let n="";return e.split("").map(((a,i)=>{n+=a;let s=null;if(n===t.action?s=(0,k.BX)(te,{children:[t.action," "]},i):n===t.domain?s=(0,k.BX)(ne,{children:[t.domain," "]},i):["FROM","INNER","JOIN","WHERE","ON","AND","NOT","NULL","IS"].includes(n)?s=(0,k.tZ)(ae,{children:n},i):["(",")"].includes(n)?s=(0,k.tZ)(ie,{children:n},i):(" "===a||"\n"===a||")"===e[i+1]||i===e.length-1)&&(s=n),s){n="";const e=s;return s=null,e}return null}))};function W(e,t,n,a){const i=n.findIndex((e=>Math.abs(l().duration(l()(e.name).diff(l()(t))).asSeconds())<86400));return{seriesName:e,type:"line",color:a.blue300,data:[],xAxisIndex:0,yAxisIndex:0,markLine:(0,u.Z)({silent:!0,animation:!1,lineStyle:{color:a.blue300,type:"dotted"},data:[{xAxis:i}],label:{show:!1}})}}const K=(e,t,n)=>{const a={seriesName:"count()",data:[]},i={seriesName:"p75()",data:[]};return e.forEach((e=>{let{count:t,p75:n,interval:s}=e;a.data.push({value:t,name:s}),i.data.push({value:n,name:s})})),[(0,F.b)(a,l().duration(H,"hours"),t,n),(0,F.b)(i,l().duration(H,"hours"),t,n)]},U=(0,a.Z)("h3",{target:"e1gfmqvs8"})("color:",(e=>e.theme.gray300),";font-size:",(e=>e.theme.fontSizeLarge),";"),V=(0,a.Z)("h4",{target:"e1gfmqvs7"})({name:"3in70x",styles:"margin:0;font-weight:normal"}),G=(0,a.Z)("div",{target:"e1gfmqvs6"})("display:flex;&>div:last-child{padding-right:",(0,v.D)(1),";}padding-bottom:",(0,v.D)(2),";"),J=(0,a.Z)("div",{target:"e1gfmqvs5"})("padding-right:",(0,v.D)(4),";flex:1;"),ee=(0,a.Z)("div",{target:"e1gfmqvs4"})("padding:",(0,v.D)(1),";margin-bottom:",(0,v.D)(3),";background:",(e=>e.theme.backgroundSecondary),";border-radius:",(e=>e.theme.borderRadius),";overflow-x:auto;white-space:pre;"),te=(0,a.Z)("b",{target:"e1gfmqvs3"})("color:",(e=>e.theme.blue400),";"),ne=(0,a.Z)("b",{target:"e1gfmqvs2"})("color:",(e=>e.theme.green400),";margin-right:-",(0,v.D)(.5),";"),ae=(0,a.Z)("b",{target:"e1gfmqvs1"})("color:",(e=>e.theme.yellow400),";"),ie=(0,a.Z)("b",{target:"e1gfmqvs0"})("color:",(e=>e.theme.pink400),";")},"./app/views/starfish/modules/databaseModule/panel/queryTransactionTable.tsx":(e,t,n)=>{n.d(t,{U:()=>g,Z:()=>_});var a=n("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),i=n("../node_modules/react/index.js"),s=n("../node_modules/@emotion/react/dist/emotion-element-6a883da9.browser.esm.js"),r=n("../node_modules/query-string/index.js"),o=n("./app/components/gridEditable/index.tsx"),d=n("./app/components/links/link.tsx"),l=n("./app/components/truncate.tsx"),c=n("./app/constants/chartPalette.tsx"),p=n("./app/icons/index.tsx"),m=n("./app/utils/useLocation.tsx"),u=n("./app/views/starfish/components/sparkline.tsx"),h=n("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const f=[{key:"transaction",name:"Transaction",width:400},{key:"spm",name:"TPM v SPM",width:200},{key:"p50",name:"Span p50 vs Txn p50",width:200}];function y(e){const{isDataLoading:t,tableData:n,sort:a,onClickSort:p,row:y,spmData:v,tpmData:Z,spanP50Data:_,txnP50Data:b,markLine:w}=e,$=(0,m.T)(),D=(0,s.u)(),E=x(n);return(0,h.tZ)(o.ZP,{isLoading:t,data:n,columnOrder:f,columnSortBy:[],grid:{renderHeadCell:e=>{const{key:t,name:n}=e;if(["p50","spm"].includes(t)){const t=e.key===a.sortHeader?.key?a.direction:void 0;return(0,h.tZ)(g,{onClick:()=>(e=>{let t;a.direction&&e.key===a.sortHeader?.key?"desc"===a.direction&&(t="asc"):t="desc",p({direction:t,sortHeader:e})})(e),direction:t,title:n})}return(0,h.tZ)("span",{children:n})},renderBodyCell:(e,t)=>((e,t)=>{const{key:n}=e,a=t[n],s={"min-height":"40px"};E[n]&&(a>E[n].max||a<E[n].min)&&(s.color=D.red400);const o=v.length&&v.find((e=>e.seriesName===t.transaction)),p=Z.length&&Z.find((e=>e.seriesName===t.transaction)),m=_.length&&_.find((e=>e.seriesName===t.transaction)),f=b.length&&b.find((e=>e.seriesName===t.transaction));return"spm"===n&&o&&p?(0,h.tZ)(u.K,{color:[c.$[4][0],c.$[4][3]],series:[o,p],markLine:w,width:e.width?e.width-e.width/5:void 0,height:40}):"transaction"===n?(0,h.BX)(i.Fragment,{children:[(0,h.tZ)(d.Z,{to:`/starfish/span/${encodeURIComponent(y.group_id)}?${r.stringify({transaction:t.transaction})}`,children:(0,h.tZ)(l.Z,{value:t[e.key],maxLength:50})}),(0,h.BX)("span",{children:["Span appears ",t.frequency?.toFixed(2),"x per txn (",t.uniqueEvents," ","total txns)"]})]}):"p50"===n&&m&&f?(0,h.tZ)(u.K,{color:[c.$[4][0],c.$[4][2]],series:[m,f],markLine:w,width:e.width?e.width-e.width/5:void 0}):(0,h.tZ)("span",{style:s,children:t[n]})})(e,t)},location:$})}function g(e){let{title:t,direction:n,onClick:a}=e;const i=n?(0,h.tZ)(Z,{size:"xs",direction:"desc"===n?"down":"up"}):null;return(0,h.BX)(v,{onClick:a,children:[t," ",i]})}y.displayName="QueryTransactionTable",g.displayName="SortableHeader";const x=e=>{const t={};return e.length>0&&Object.entries(e[0]).forEach((n=>{let[a,i]=n;"number"==typeof i&&(t[a]=function(e,t){const n=[...e].sort(((e,n)=>e[t]-n[t]));if(e.length<4)return{min:e[0][t],max:e[e.length-1][t]};const a=n[Math.floor(n.length*(1/4))][t],i=n[Math.ceil(n.length*(3/4))][t],s=i-a;return{min:a-1.5*s,max:i+1.5*s}}(e,a))})),t},v=(0,a.Z)("div",{target:"e1pxi4w71"})({name:"e0dnmk",styles:"cursor:pointer"}),Z=(0,a.Z)(p.CC,{target:"e1pxi4w70"})({name:"40f4ru",styles:"vertical-align:top"}),_=y},"./app/views/starfish/modules/databaseModule/queries.ts":(e,t,n)=>{n.d(t,{$R:()=>T,Ep:()=>q,OJ:()=>v,VT:()=>Z,W3:()=>$,Yy:()=>E,_y:()=>_,c0:()=>b,gy:()=>D,mi:()=>w,rq:()=>x,sE:()=>S,uU:()=>R,uw:()=>k}),n("../node_modules/core-js/modules/es.array.push.js");var a=n("../node_modules/moment/moment.js"),i=n("./app/utils/discover/discoverQuery.tsx"),s=n("./app/utils/discover/eventView.tsx"),r=n("./app/utils/discover/genericDiscoverQuery.tsx"),o=n("./app/utils/discover/types.tsx"),d=n("./app/utils/queryClient.tsx"),l=n("./app/utils/useLocation.tsx"),c=n("./app/utils/useOrganization.tsx"),p=n("./app/utils/usePageFilters.tsx"),m=n("./app/views/starfish/utils/constants.tsx"),u=n("./app/views/starfish/utils/dates.tsx"),h=n("./app/views/starfish/utils/useSpansQuery.tsx");const f="\n  startsWith(span_operation, 'db') and\n  span_operation != 'db.redis' and\n  module = 'db' and\n  action != ''\n",y="\n  -power(10, floor(log10(count()))), -quantile(0.75)(exclusive_time)\n",g=604800,x=()=>{const e=(0,p.Z)(),{startTime:t,endTime:n}=(0,u.tZ)(e),a=L(t,n),i=`\n  select\n    domain as key,\n    quantile(0.75)(exclusive_time) as value\n  from default.spans_experimental_starfish\n  where\n    ${f}\n    ${a}\n  group by domain\n  order by ${y}\n  `;return(0,d.aM)({queryKey:["table",e.selection.datetime],queryFn:()=>fetch(`${m.M}/?query=${i}`).then((e=>e.json())),retry:!1,initialData:[]})},v=e=>{const t=(0,p.Z)(),{startTime:n,endTime:a}=(0,u.tZ)(t),i=L(n,a),s=`\n  select\n    floor(quantile(0.75)(exclusive_time), 5) as p75,\n    action,\n    count() as count,\n    toStartOfInterval(start_timestamp, INTERVAL ${e} hour) as interval\n  from default.spans_experimental_starfish\n  where\n    ${f}\n    ${i} and\n    action in (${r=i,`\n  select action\n  from default.spans_experimental_starfish\n  where\n    ${f}\n    ${r}\n  group by action\n  order by ${y}\n  limit 5\n  `})\n  group by action, interval\n  order by action, interval\n  `;var r;return(0,d.aM)({queryKey:["topGraph",t.selection.datetime],queryFn:()=>fetch(`${m.M}/?query=${s}`).then((e=>e.json())),retry:!1,initialData:[]})},Z=(e,t)=>{const n=(0,p.Z)(),i=(0,l.T)(),{startTime:c,endTime:h}=(0,u.tZ)(n),g=((e,t)=>{const n=`domain IN ('${e.join("', '")}')`;return`\n  SELECT\n    transaction\n  FROM default.spans_experimental_starfish\n  WHERE\n    ${[f,n].join(" AND ")}\n    ${t}\n  GROUP BY transaction\n  ORDER BY ${y}\n  LIMIT 5\n`})(e,L(c,h)),{start:x,end:v,period:Z}=n.selection.datetime,_=(0,d.aM)({enabled:!!e?.length,queryKey:["topTransactionNames",e.join(","),x,v],queryFn:()=>fetch(`${m.M}/?query=${g}`).then((e=>e.json())),retry:!1,initialData:[]}),b={id:void 0,name:"Db module - epm/p75 for top transactions",query:`transaction:[${_.data?.map((e=>e.transaction)).join(",")}]`,projects:[1],fields:["transaction","epm()","p75(transaction.duration)"],version:1,topEvents:"5",start:x?.toString(),end:v?.toString(),dataset:o.as.METRICS_ENHANCED,interval:`${t}h`,yAxis:["epm()","p75(transaction.duration)"]},w=s.ZP.fromNewQueryWithLocation(b,i);w.statsPeriod=Z??void 0;const $=(E={eventView:w,referrer:"api.starfish.database.charts",location:i,orgSlug:"sentry",queryExtras:{interval:`${t}h`,yAxis:["epm()","p75(transaction.duration)"],excludeOther:"1",topEvents:"5",per_page:void 0}},(0,r.JC)({route:"events-stats",shouldRefetchData:M,afterFetch:(e,t)=>{const{fields:n,...a}=e.meta??{};return{...e,meta:{...n,...a}}},...E})),D=[];var E;return!$.isLoading&&$.data&&Object.entries($.data).forEach((e=>{let[t,n]=e;n["epm()"].data.forEach((e=>{D.push({transaction:t,interval:(0,a.unix)(e[0]).format("YYYY-MM-DDTHH:mm:ss"),epm:e[1][0].count})})),n["p75(transaction.duration)"].data.forEach((e=>{D.push({transaction:t,interval:(0,a.unix)(e[0]).format("YYYY-MM-DDTHH:mm:ss"),p75:e[1][0].count})}))})),{...$,data:D}},_=e=>{const t=(0,p.Z)(),{startTime:n,endTime:a}=(0,u.tZ)(t),i=L(n,a),s=`\n  select\n    floor(quantile(0.75)(exclusive_time), 5) as p75,\n    domain,\n    count() as count,\n    toStartOfInterval(start_timestamp, INTERVAL ${e} hour) as interval\n  from default.spans_experimental_starfish\n  where\n    ${f}\n    ${i} and\n    domain in (${r=i,`\n  select domain\n  from default.spans_experimental_starfish\n  where\n    ${f}\n    ${r} and\n    domain != ''\n   group by domain\n   order by ${y}\n   limit 5\n  `})\n  group by interval, domain\n  order by interval, domain\n  `;var r;const o=(0,d.aM)({queryKey:["topTable",t.selection.datetime],queryFn:()=>fetch(`${m.M}/?query=${s}`).then((e=>e.json())),retry:!1,initialData:[]}),l=`\n  select\n  floor(quantile(0.75)(exclusive_time), 5) as p75,\n  count() as count,\n  toStartOfInterval(start_timestamp, INTERVAL ${e} hour) as interval\n  from default.spans_experimental_starfish\n  where\n    domain not in ('${[...new Set(o.data.map((e=>e.domain)))].join("', '")}')\n    AND ${f}\n    ${i}\n  group by interval\n  order by interval\n  `,c=(0,d.aM)({enabled:!o.isLoading&&!!o.data?.length,queryKey:["topTableOther",t.selection.datetime],queryFn:()=>fetch(`${m.M}/?query=${l}`).then((e=>e.json())),retry:!1,initialData:[]});c.data.forEach((e=>e.domain="other"));const h=[...o.data,...c.data];return{...c,data:h}},b=(e,t,n,a)=>{const i=(0,p.Z)(),{startTime:s,endTime:r}=(0,u.tZ)(i),o=L(s,r),l=j(t,n)??y,c=a?`and transaction='${a}'`:"",h=`\n    SELECT\n      transaction,\n      count() AS count,\n      quantile(0.75)(exclusive_time) as p75\n    FROM spans_experimental_starfish\n    WHERE\n      ${f}\n      ${o} AND\n      group_id = '${e.group_id}'\n      ${c}\n    GROUP BY transaction\n    ORDER BY ${l}\n    LIMIT 5\n  `;return(0,d.aM)({queryKey:["dbQueryDetailsTable",e.group_id,i.selection.datetime,t,n],queryFn:()=>fetch(`${m.M}/?query=${h}`).then((e=>e.json())),retry:!0,initialData:[]})},w=e=>{const t=(0,p.Z)(),{startTime:n,endTime:a}=(0,u.tZ)(t),i=L(n,a),s=`\n    SELECT\n      minIf(transaction_id, equals(timestamp, '${e.lastSeen}')) as latest,\n      minIf(transaction_id, equals(timestamp, '${e.firstSeen}')) as first\n    FROM spans_experimental_starfish\n    WHERE\n      ${f}\n      ${i} AND\n      group_id = '${e.group_id}'\n    HAVING latest > 0 and first > 0\n    LIMIT 10\n  `;return(0,d.aM)({queryKey:["getExampleTransaction",e.group_id],queryFn:()=>fetch(`${m.M}/?query=${s}`).then((e=>e.json())),retry:!0,initialData:[]})},$=(e,t,n,a,i)=>{const s=(0,p.Z)(),{startTime:r,endTime:o}=(0,u.tZ)(s),l=L(r,o),c=j(t,n)??y,h=i?`and transaction='${i}'`:"",g=`\n    SELECT\n      transaction,\n      toStartOfInterval(start_timestamp, INTERVAL ${a} hour) as interval,\n      quantile(0.50)(exclusive_time) AS p50,\n      divide(count(), ${(o.unix()-r.unix())/60}) AS spm\n    FROM spans_experimental_starfish\n    WHERE\n      transaction in (\n        SELECT\n          transaction\n        FROM spans_experimental_starfish\n        WHERE\n          ${f}\n          ${l} AND\n          group_id = '${e.group_id}'\n          ${h}\n        GROUP BY transaction\n        ORDER BY ${c}\n        LIMIT 5\n      ) and\n      ${f}\n      ${l} AND\n      group_id = '${e.group_id}'\n    GROUP BY transaction, interval\n    ORDER BY transaction, interval, ${c}\n  `;return(0,d.aM)({queryKey:["dbQueryDetailsSparklines",e.group_id,s.selection.datetime,t,n],queryFn:()=>fetch(`${m.M}/?query=${g}`).then((e=>e.json())),retry:!0,initialData:[]})},D=(e,t)=>{const n=(0,p.Z)(),{startTime:a,endTime:i}=(0,u.tZ)(n),s=L(a,i),r=`\n    SELECT\n      toStartOfInterval(start_timestamp, INTERVAL ${t} HOUR) as interval,\n      quantile(0.75)(exclusive_time) as p75,\n      count() as count\n    FROM spans_experimental_starfish\n    WHERE\n      ${f}\n      ${s} AND\n      group_id = '${e.group_id}'\n    GROUP BY interval\n    ORDER BY interval\n  `;return(0,d.aM)({queryKey:["dbQueryDetailsGraph",e.group_id,n.selection.datetime],queryFn:()=>fetch(`${m.M}/?query=${r}&format=sql`).then((e=>e.json())),retry:!1,initialData:[]})},E=e=>{const t=(0,p.Z)(),{startTime:n,endTime:a}=(0,u.tZ)(t),i=L(n,a),s=`\n    SELECT\n      transaction,\n      count(DISTINCT transaction_id) as uniqueEvents\n    FROM spans_experimental_starfish\n    WHERE\n      ${f}\n      ${i} AND\n      group_id = '${e.group_id}'\n    GROUP BY transaction\n    ORDER BY ${y}\n   `;return(0,d.aM)({queryKey:["dbQueryDetailsEventCount",e.group_id,t.selection.datetime],queryFn:()=>fetch(`${m.M}/?query=${s}`).then((e=>e.json())),retry:!0,initialData:[]})},T=e=>{const{action:t,filterNew:n,filterOld:i,sortDirection:s,sortKey:r,table:o,transaction:l,limit:c}=e,h=(0,p.Z)(),{startTime:x,endTime:v}=(0,u.tZ)(h),Z=L(x,v),_=n?"newish = 1":void 0,b=i?"retired = 1":void 0,w=[f,l?`transaction='${l}'`:null,o&&"ALL"!==o?`domain = '${o}'`:void 0,t&&"ALL"!==t?`action = '${t}'`:void 0].filter((e=>!!e)),$=v.unix()-x.unix(),D=((e,t,n)=>{const{start_timestamp:i,end_timestamp:s}=(0,u.SW)({start:(0,a.unix)(t.unix()+e/10).format("YYYY-MM-DD HH:mm:ss"),end:(0,a.unix)(n.unix()-e/10).format("YYYY-MM-DD HH:mm:ss")});return e>g?`(\n        greater(min(start_timestamp), '${i}') and\n        greater(max(start_timestamp), '${s}')\n      ) as newish`:"0 as newish"})($,x,v),E=((e,t,n)=>{const{start_timestamp:i,end_timestamp:s}=(0,u.SW)({start:(0,a.unix)(t.unix()+e/10).format("YYYY-MM-DD HH:mm:ss"),end:(0,a.unix)(n.unix()-e/10).format("YYYY-MM-DD HH:mm:ss")});return e>g?`(\n        less(max(start_timestamp), '${s}') and\n        less(min(start_timestamp), '${i}')\n      ) as retired`:"0 as retired"})($,x,v),T=[_,b].filter((e=>!!e)),S=j(r,s)??y,k=`\n  select\n    description,\n    group_id, count() as count,\n    (divide(count, ${(v.unix()-x.unix())/60}) AS epm),\n    quantile(0.75)(exclusive_time) as p75,\n    uniq(transaction) as transactions,\n    sum(exclusive_time) as total_time,\n    domain,\n    action,\n    data_keys,\n    data_values,\n    min(start_timestamp) as firstSeen,\n    max(start_timestamp) as lastSeen,\n    ${D},\n    ${E}\n  from default.spans_experimental_starfish\n  where\n    ${w.join(" AND ")}\n    ${Z}\n  group by\n    action,\n    description,\n    group_id,\n    domain,\n    data_keys,\n    data_values\n  ${T.length>0?"having":""}\n    ${T.join(" and ")}\n  order by ${S}\n  limit ${c??100}\n`;return(0,d.aM)({queryKey:["endpoints",l,o,h.selection.datetime,r,s,_,b],cacheTime:1e4,queryFn:()=>fetch(`${m.M}/?query=${k}&format=sql`).then((e=>e.json())),retry:!1,initialData:[]})},S=(e,t)=>{const{selection:{datetime:n}}=(0,p.Z)();return(0,h.Y7)(s.ZP.fromSavedQuery({name:"",fields:["transaction","epm()","p50(transaction.duration)"],yAxis:["epm()","p50(transaction.duration)"],orderby:"-count",query:`transaction:["${e.join('","')}"]`,topEvents:"5",start:n.start,end:n.end,range:n.period,dataset:o.as.METRICS,interval:`${t}h`,projects:[1],version:2}),[])},k=e=>{const t=(0,l.T)(),{slug:n}=(0,c.Z)(),a=s.ZP.fromNewQueryWithLocation({fields:["transaction"],name:"Db module - profile",query:`transaction:[${e.join(",")}] has:profile.id`,projects:[1],version:1,orderby:"id"},t);return(0,i._)({eventView:a,location:t,orgSlug:n,queryExtras:{per_page:"10"}})},q=e=>{const t=`/api/0/projects/sentry/sentry/events/${e?.replaceAll("-","")}/`;return(0,d.aM)({enabled:!!e,queryKey:["event",e],queryFn:()=>fetch(t).then((e=>e.json())),retry:!1,initialData:{}})},j=(e,t)=>{if(t&&e)return t??="",`${e} ${t}`},L=(e,t)=>{const{start_timestamp:n,end_timestamp:a}=(0,u.SW)({start:e.format("YYYY-MM-DD HH:mm:ss"),end:t.format("YYYY-MM-DD HH:mm:ss")});return`\n  ${n?`AND greaterOrEquals(start_timestamp, '${n}')`:""}\n  ${a?`AND lessOrEquals(start_timestamp, '${a}')`:""}\n  `},M=(e,t)=>e.transactionName!==t.transactionName||e.transactionThreshold!==t.transactionThreshold||e.transactionThresholdMetric!==t.transactionThresholdMetric,R=e=>{let{datetime:t,transaction:n}=e;const{start_timestamp:a,end_timestamp:i}=(0,u.SW)(t);return`\n    SELECT\n    description,\n    toStartOfInterval(start_timestamp, INTERVAL 12 HOUR) as interval,\n    count() AS count,\n    quantile(0.75)(exclusive_time) as p75\n    FROM spans_experimental_starfish\n    WHERE module = 'db'\n    ${n?`AND transaction = '${n}'`:""}\n    ${a?`AND greaterOrEquals(start_timestamp, '${a}')`:""}\n    ${i?`AND lessOrEquals(start_timestamp, '${i}')`:""}\n    GROUP BY description, interval\n    ORDER BY interval asc\n  `}},"./app/views/starfish/modules/databaseModule/utils.ts":(e,t,n)=>{n.d(t,{F:()=>r}),n("../node_modules/core-js/modules/es.array.push.js");var a=n("../node_modules/moment/moment.js"),i=n.n(a),s=n("./app/views/starfish/utils/zeroFillSeries.tsx");const r=(e,t,n,a,r,o,d)=>{const l={};return e.forEach((e=>{const a={value:e[n],name:e.interval};l[e[t]]||(l[e[t]]={seriesName:e[t],data:[]}),a.value&&l[e[t]].data.push(a)})),Object.values(l).map((e=>(0,s.b)(e,i().duration(o,"hours"),a,r,d)))}},"./app/views/starfish/utils/combineTableDataWithSparklineData.tsx":(e,t,n)=>{n.d(t,{Z:()=>i}),n("../node_modules/core-js/modules/es.array.push.js");var a=n("./app/views/starfish/utils/zeroFillSeries.tsx");function i(e,t,n){const i={};return t.forEach((e=>{let{description:t,interval:n,count:a,p75:s}=e;t in i?i[t].push({name:n,count:a,p75:s}):i[t]=[{name:n,count:a,p75:s}]})),e.map((e=>{const t=e.description,s={seriesName:"throughput",data:i[t]?.map((e=>{let{name:t,count:n}=e;return{name:t,value:n}}))},r={seriesName:"p75 Trend",data:i[t]?.map((e=>{let{name:t,p75:n}=e;return{name:t,value:n}}))},o=(0,a.b)(s,n),d=(0,a.b)(r,n);return{...e,throughput:o,p75_trend:d}}))}}}]);
//# sourceMappingURL=../sourcemaps/app_views_starfish_components_chartPanel_tsx-app_views_starfish_modules_databaseModule_databa-e2ae20.8120d250432a6c80fbd206fda3f4621d.js.map