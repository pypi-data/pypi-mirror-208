"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_views_starfish_modules_databaseModule_index_tsx"],{"./app/components/performance/searchBar.tsx":(e,t,a)=>{a.d(t,{D:()=>S,Z:()=>_});var s=a("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),n=(a("../node_modules/core-js/modules/es.array.push.js"),a("../node_modules/core-js/modules/es.error.cause.js"),a("../node_modules/react/index.js")),r=a("../node_modules/react-router/es/index.js"),o=a("../node_modules/lodash/debounce.js"),i=a.n(o),l=a("./app/components/searchBar.tsx"),d=a("./app/components/smartSearchBar/utils.tsx"),c=a("./app/constants/index.tsx"),p=a("./app/locale.tsx"),u=a("./app/utils/discover/genericDiscoverQuery.tsx"),m=a("./app/utils/tokenizeSearch.tsx"),h=a("./app/utils/useApi.tsx"),g=a("./app/utils/useOnClickOutside.tsx"),x=a("./app/utils/withDomainRequired.tsx"),f=a("./app/views/performance/transactionSummary/utils.tsx"),v=a("./app/components/smartSearchBar/searchDropdown.tsx"),b=a("./app/components/smartSearchBar/types.tsx"),Z=a("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function w(e){const{organization:t,eventView:a,onSearch:s,query:o}=e,[w,_]=(0,n.useState)([]),T=w[0]?.children?.length||0,[k,D]=(0,n.useState)(-1),[L,B]=(0,n.useState)(!1),E=()=>B(!1),[P,z]=(0,n.useState)(!1),[A,q]=(0,n.useState)(o),N=(0,n.useRef)(null);(0,g.Z)(N,(0,n.useCallback)(E,[]));const F=(0,h.Z)(),$=a.clone(),M=`/organizations/${t.slug}/events/`,O=$.project?.map(String),V=(0,n.useCallback)(i()((async e=>{try{z(!0);const t=new m.MY("");t.addFilterValues("transaction",[S(e)],!1),t.addFilterValues("event.type",["transaction"]),Object.keys(F.activeRequests).length&&F.clear();const[a]=await(0,u.AA)(F,M,{field:["transaction","project_id","count()"],project:O,sort:"-count()",query:t.formatString(),statsPeriod:$.statsPeriod,referrer:"api.performance.transaction-name-search-bar"}),s=a.data.reduce(((e,t)=>(e.children.push({value:y(t),title:t.transaction,type:b.q.LINK,desc:""}),e)),{title:"All Transactions",children:[],icon:null,type:"header"});D(-1),_([s])}catch(e){throw new Error("Unable to fetch event field values")}finally{z(!1)}}),c.Dk,{leading:!0}),[F,M,$.statsPeriod,O.join(",")]),I=e=>{const t=j(e);R(t.transaction,!1)},R=(e,t)=>{_([]),q(e),e=new m.MY(e).formatString(),s(e?t?e:`transaction:"${e}"`:""),E()};return(0,Z.BX)(C,{"data-test-id":"transaction-search-bar",ref:N,children:[(0,Z.tZ)(l.Z,{placeholder:(0,p.t)("Search Transactions"),onChange:e=>{if(q(e),0===e.length&&s(""),e.length<3)return _([]),void E();B(!0),V(e)},onKeyDown:e=>{const{key:t}=e;if(!P)if("Escape"===t&&L)E();else{if(("ArrowUp"===t||"ArrowDown"===t)&&L&&T>0){const e=w[0].children[k],a=(k+T+("ArrowUp"===t?-1:1))%T;D(a);const s=w[0].children[a];let n=w;return e&&(n=(0,d.$l)(w,e,!1)),s&&(n=(0,d.$l)(n,s,!0)),void _(n)}if("Enter"===t){e.preventDefault();const t=w[0]?.children[k];t?.value?I(t.value):R(A,!0)}}},query:A}),L&&(0,Z.tZ)(v.Z,{maxMenuHeight:300,searchSubstring:A,loading:P,items:w,onClick:I,onIconClick:e=>{(e=>{const{transaction:a,project_id:s}=e,n=$.generateQueryStringObject();_([]);const o=(0,f.e1)({orgSlug:t.slug,transaction:a,projectID:String(s),query:n});r.browserHistory.push((0,x.D)(o))})(j(e))}})]})}w.displayName="SearchBar";const y=e=>`${e.transaction}:${e.project_id}`,j=e=>{const t=e.lastIndexOf(":");return{project_id:parseInt(e.slice(t+1),10),transaction:e.slice(0,t)}},S=e=>(e.startsWith("*")||(e="*"+e),e.endsWith("*")||(e+="*"),e),C=(0,s.Z)("div",{target:"efn8czs0"})({name:"bjn8wh",styles:"position:relative"}),_=w},"./app/components/searchBar.tsx":(e,t,a)=>{a.d(t,{Z:()=>x,p:()=>g});var s=a("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),n=a("../node_modules/react/index.js"),r=a("./app/components/button.tsx"),o=a("./app/components/inputGroup.tsx"),i=a("./app/icons/index.tsx"),l=a("./app/icons/iconClose.tsx"),d=a("./app/locale.tsx"),c=a("./app/styles/space.tsx"),p=a("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function u(e){let{query:t,defaultQuery:a="",onChange:s,onSearch:r,width:c,size:u,className:x,trailing:f,...v}=e;const b=(0,n.useRef)(null),[Z,w]=(0,n.useState)(t??a);(0,n.useEffect)((()=>{"string"==typeof t&&w(t)}),[t]);const y=(0,n.useCallback)((e=>{const{value:t}=e.target;w(t),s?.(t)}),[s]),j=(0,n.useCallback)((e=>{e.preventDefault(),b.current?.blur(),r?.(Z)}),[r,Z]),S=(0,n.useCallback)((()=>{w(""),s?.(""),r?.("")}),[s,r]);return(0,p.tZ)(m,{onSubmit:j,className:x,children:(0,p.BX)(o.BZ,{children:[(0,p.tZ)(o.BZ.LeadingItems,{disablePointerEvents:!0,children:(0,p.tZ)(i.jV,{color:"subText",size:"xs"===u?"xs":"sm"})}),(0,p.tZ)(h,{...v,ref:b,type:"text",name:"query",autoComplete:"off",value:Z,onChange:y,width:c,size:u}),(0,p.BX)(o.BZ.TrailingItems,{children:[f,!!Z&&(0,p.tZ)(g,{size:"zero",borderless:!0,onClick:S,icon:(0,p.tZ)(l.b,{size:"xs"}),"aria-label":(0,d.t)("Clear")})]})]})})}u.displayName="SearchBar";const m=(0,s.Z)("form",{target:"elu65nr2"})({name:"4bgdod",styles:"display:block;position:relative"}),h=(0,s.Z)(o.BZ.Input,{target:"elu65nr1"})((e=>e.width&&`width: ${e.width};`),";"),g=(0,s.Z)(r.zx,{target:"elu65nr0"})("color:",(e=>e.theme.subText),";padding:",(0,c.D)(.5),";"),x=u},"./app/utils/performance/contexts/pageError.tsx":(e,t,a)=>{a.d(t,{De:()=>d,V_:()=>i,YY:()=>l});var s=a("../node_modules/react/index.js"),n=a("./app/components/alert.tsx"),r=a("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const o=(0,s.createContext)({pageError:void 0,setPageError:e=>{}});function i(e){let{children:t}=e;const[a,n]=(0,s.useState)();return(0,r.tZ)(o.Provider,{value:{pageError:a,setPageError:n},children:t})}function l(){const{pageError:e}=(0,s.useContext)(o);return e?(0,r.tZ)(n.bZ,{type:"error","data-test-id":"page-error-alert",showIcon:!0,children:e}):null}i.displayName="PageErrorProvider",l.displayName="PageErrorAlert";const d=()=>(0,s.useContext)(o)},"./app/views/starfish/modules/databaseModule/index.tsx":(e,t,a)=>{a.r(t),a.d(t,{default:()=>O});var s=a("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),n=(a("../node_modules/core-js/modules/es.array.push.js"),a("../node_modules/react/index.js")),r=a("../node_modules/moment/moment.js"),o=a.n(r),i=a("./app/components/datePageFilter.tsx"),l=a("./app/components/layouts/thirds.tsx"),d=a("./app/components/organizations/pageFilters/parse.tsx"),c=a("./app/components/performance/searchBar.tsx"),p=a("./app/components/switchButton.tsx"),u=a("./app/locale.tsx"),m=a("./app/styles/space.tsx"),h=a("./app/utils/discover/eventView.tsx"),g=a("./app/utils/performance/contexts/pageError.tsx"),x=a("./app/utils/queryClient.tsx"),f=a("./app/utils/tokenizeSearch.tsx"),v=a("./app/utils/useLocation.tsx"),b=a("./app/utils/useOrganization.tsx"),Z=a("./app/utils/usePageFilters.tsx"),w=a("./app/views/starfish/modules/databaseModule/queries.ts"),y=a("./app/views/starfish/utils/combineTableDataWithSparklineData.tsx"),j=a("./app/views/starfish/utils/constants.tsx"),S=a("../node_modules/@emotion/react/dist/emotion-element-6a883da9.browser.esm.js"),C=a("./app/components/compactSelect/index.tsx"),_=a("./app/views/starfish/components/chart.tsx"),T=a("./app/views/starfish/components/chartPanel.tsx"),k=a("./app/views/starfish/modules/databaseModule/utils.ts"),D=a("./app/views/starfish/utils/dates.tsx"),L=a("./app/views/starfish/utils/zeroFillSeries.tsx"),B=a("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const E=12;function P(e,t){const a=(0,B.tZ)("span",{children:(0,u.t)("Operation")});return[{value:"ALL",prefix:a,label:"ALL"},...e.map((e=>({value:e.key,prefix:a,label:`${e.key||"null"} - ${e.value} ${t}`})))]}function z(e){let{table:t,onChange:a}=e;const s=(0,Z.Z)(),r=(0,S.u)(),{startTime:i,endTime:l}=(0,D.tZ)(s),{start_timestamp:d,end_timestamp:c}=(0,D.SW)(s.selection.datetime),{data:p}=(0,w.rq)(),{isLoading:m,data:h}=(0,w.OJ)(E),{isLoading:g,data:x}=(0,w._y)(E),f={},v={};g||(x.forEach((e=>{f[e.domain]={seriesName:e.domain,data:[]},v[e.domain]={seriesName:e.domain,data:[]}})),x.forEach((e=>{f[e.domain].data.push({value:e.p75,name:e.interval}),v[e.domain].data.push({value:e.count,name:e.interval})})));const b=[...new Set(x.map((e=>e.domain)))],{isLoading:y,data:j}=(0,w.VT)(b,E),z=(0,k.F)(j,"transaction","epm",i,l,E),F=(0,k.F)(j,"transaction","p75",i,l,E),$=Object.values(f).map((e=>(0,L.b)(e,o().duration(E,"hours"),o()(d),o()(c)))),M=Object.values(v).map((e=>(0,L.b)(e,o().duration(E,"hours"),o()(d),o()(c)))),O={},V={};m||(h.forEach((e=>{V[e.action]={seriesName:e.action,data:[]},O[e.action]={seriesName:e.action,data:[]}})),h.forEach((e=>{V[e.action].data.push({value:e.p75,name:e.interval}),O[e.action].data.push({value:e.count,name:e.interval})})));const I=[...r.charts.getColorPalette(6).slice(2,7),r.gray300];return(0,B.BX)(n.Fragment,{children:[(0,B.BX)(q,{children:[(0,B.tZ)(N,{children:(0,B.tZ)(T.Z,{title:(0,u.t)("Top Transactions P75"),children:(0,B.tZ)(_.Z,{statsPeriod:"24h",height:180,data:F,start:"",end:"",loading:y,utc:!1,grid:{left:"0",right:"0",top:"16px",bottom:"8px"},definedAxisTicks:4,isLineChart:!0,showLegend:!0})})}),(0,B.tZ)(N,{children:(0,B.tZ)(T.Z,{title:(0,u.t)("Top Transactions Throughput"),children:(0,B.tZ)(_.Z,{statsPeriod:"24h",height:180,data:z,start:"",end:"",loading:y,utc:!1,grid:{left:"0",right:"0",top:"16px",bottom:"8px"},definedAxisTicks:4,showLegend:!0,isLineChart:!0})})})]}),1===p.length&&""===p[0].key?(0,B.tZ)(n.Fragment,{}):(0,B.BX)(n.Fragment,{children:[(0,B.BX)(q,{children:[(0,B.tZ)(N,{children:(0,B.tZ)(T.Z,{title:(0,u.t)("Slowest Tables P75"),children:(0,B.tZ)(_.Z,{statsPeriod:"24h",height:180,data:$,start:"",end:"",chartColors:I,loading:g,utc:!1,grid:{left:"0",right:"0",top:"16px",bottom:"8px"},definedAxisTicks:4,isLineChart:!0,showLegend:!0})})}),(0,B.tZ)(N,{children:(0,B.tZ)(T.Z,{title:(0,u.t)("Table Throughput"),children:(0,B.tZ)(_.Z,{statsPeriod:"24h",height:180,data:M,start:"",end:"",chartColors:I,loading:m,utc:!1,grid:{left:"0",right:"0",top:"16px",bottom:"8px"},definedAxisTicks:4,showLegend:!0,isLineChart:!0})})})]}),(0,B.tZ)(A,{children:(0,B.tZ)(C.Z,{value:t,triggerProps:{prefix:(0,u.t)("Table")},options:P(p,"p75"),menuTitle:"Table",onChange:e=>a(e.value)})})]})]})}z.displayName="DatabaseChartView";const A=(0,s.Z)("div",{target:"efxhah22"})("display:flex;margin-bottom:",(0,m.D)(2),";"),q=(0,s.Z)("div",{target:"efxhah21"})("display:flex;flex-direction:row;flex-wrap:wrap;gap:",(0,m.D)(2),";"),N=(0,s.Z)("div",{target:"efxhah20"})({name:"82a6rk",styles:"flex:1"});var F=a("./app/views/starfish/modules/databaseModule/databaseTableView.tsx"),$=a("./app/views/starfish/modules/databaseModule/panel/index.tsx");function M(){const e=(0,v.T)(),t=(0,b.Z)(),a=h.ZP.fromLocation(e),[s,r]=(0,n.useState)("ALL"),[p,m]=(0,n.useState)(!1),[S,C]=(0,n.useState)(!1),[_,T]=(0,n.useState)(""),[k,D]=(0,n.useState)({direction:void 0,sortHeader:void 0}),[L,E]=(0,n.useState)({selected:void 0,next:void 0,prev:void 0}),{isLoading:P,data:A,isRefetching:q}=(0,w.$R)({transaction:_,table:s,filterNew:p,filterOld:S,sortKey:k.sortHeader?.key,sortDirection:k.direction}),N=(0,Z.Z)(),{selection:M}=N,{projects:O,environments:X,datetime:Y}=M;(0,x.WE)([`/organizations/${t.slug}/events-starfish/`,{query:{environment:X,project:O.map((e=>String(e))),...(0,d.fK)(Y)}}],{staleTime:10});const{data:W}=(0,x.aM)({queryKey:["dbAggregates",_,p,S],queryFn:()=>fetch(`${j.M}/?query=${(0,w.uU)({datetime:N.selection.datetime,transaction:_})}`).then((e=>e.json())),retry:!1,initialData:[]}),K=(0,y.Z)(A,W,o().duration(12,"hours")),Q={};W.forEach((e=>{let{description:t,interval:a,count:s,p75:n}=e;t in Q?Q[t].push({name:a,count:s,p75:n}):Q[t]=[{name:a,count:s,p75:n}]})),(0,n.useEffect)((()=>{function e(e){let{keyCode:t}=e;E((e=>{if(e.selected){if(e.prev&&37===t)return H(e.prev);if(e.next&&39===t)return H(e.next)}return e}))}return document.addEventListener("keydown",e),function(){document.removeEventListener("keydown",e)}}),[A]);const H=(e,t)=>{t??=A.findIndex((t=>t.group_id===e.group_id));const a=t>0?A[t-1]:void 0,s=t<A.length-1?A[t+1]:void 0;return{selected:e,next:s,prev:a}},U=(e,t)=>{E(H(e,t))};return(0,B.tZ)(l.T3,{children:(0,B.BX)(g.V_,{children:[(0,B.tZ)(l.h4,{children:(0,B.tZ)(l.oB,{children:(0,B.tZ)(l.Dx,{children:(0,u.t)("Database")})})}),(0,B.tZ)(l.uT,{children:(0,B.BX)(l.or,{fullWidth:!0,children:[(0,B.tZ)(g.YY,{}),(0,B.tZ)(V,{children:(0,B.tZ)(i.Z,{alignDropdown:"left"})}),(0,B.tZ)(z,{location:e,table:s,onChange:r}),(0,B.BX)(I,{children:[(0,B.tZ)(R,{label:"Filter New Queries",isActive:p,size:"lg",toggle:()=>{m(!p),p||C(!1)}}),(0,B.tZ)(R,{label:"Filter Old Queries",isActive:S,size:"lg",toggle:()=>{C(!S),S||m(!1)}})]}),(0,B.tZ)(I,{children:(0,B.tZ)(c.Z,{organization:t,eventView:a,onSearch:e=>(e=>{const t=new f.MY(e),a=t.getFilterValues("transaction");a.length?T(a[0]):t.freeText.length>0?T(t.freeText.join(" ")):T("")})(e),query:_})}),(0,B.tZ)(F.Z,{location:e,data:K,isDataLoading:P||q,onSelect:U,onSortChange:D,selectedRow:L.selected}),(0,B.tZ)($.Z,{isDataLoading:P||q,onRowChange:e=>{U(e)},mainTableSort:k,row:L.selected,nextRow:L.next,prevRow:L.prev,onClose:()=>E({selected:void 0}),transaction:_})]})})]})})}M.displayName="DatabaseModule";const O=M,V=(0,s.Z)("div",{target:"e3mtf2m1"})("display:flex;flex-direction:row;gap:",(0,m.D)(1),";margin-bottom:",(0,m.D)(2),";"),I=(0,s.Z)("div",{target:"e3mtf2m0"})("margin-bottom:",(0,m.D)(2),";");function R(e){return(0,B.BX)("span",{style:{display:"inline-flex",gap:(0,m.D)(1),paddingRight:(0,m.D)(2),alignItems:"center"},children:[(0,B.tZ)("span",{children:e.label}),(0,B.tZ)(p.Z,{...e})]})}R.displayName="LabelledSwitch"}}]);
//# sourceMappingURL=../sourcemaps/app_views_starfish_modules_databaseModule_index_tsx.d9ada9cd5f55fd6ed5afa99c8019bb36.js.map