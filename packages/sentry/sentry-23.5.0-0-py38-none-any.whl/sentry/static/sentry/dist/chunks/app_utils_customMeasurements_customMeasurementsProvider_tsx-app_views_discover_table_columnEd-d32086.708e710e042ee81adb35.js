"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_utils_customMeasurements_customMeasurementsProvider_tsx-app_views_discover_table_columnEd-d32086"],{"./app/utils/customMeasurements/customMeasurementsProvider.tsx":(e,t,s)=>{s.d(t,{L:()=>m});var n=s("../node_modules/react/index.js"),i=s("./app/actionCreators/indicator.tsx"),o=s("./app/components/events/eventCustomPerformanceMetrics.tsx"),r=s("./app/components/organizations/pageFilters/parse.tsx"),a=s("./app/locale.tsx"),l=s("./app/utils/handleXhrErrorResponse.tsx"),d=s("./app/utils/useApi.tsx"),u=s("./app/utils/customMeasurements/customMeasurementsContext.tsx"),c=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function m(e){let{children:t,organization:s,selection:m}=e;const g=(0,d.Z)(),[p,h]=(0,n.useState)({customMeasurements:{}});return(0,n.useEffect)((()=>{let e=!1;return(s.features.includes("dashboards-mep")||s.features.includes("mep-rollout-flag"))&&function(e,t,s){const n=s?.datetime?{...(0,r.fK)(s.datetime)}:{};return s?.projects&&(n.project=s.projects.map(String)),e.requestPromise(`/organizations/${t.slug}/measurements-meta/`,{method:"GET",query:n})}(g,s,m).then((t=>{if(e)return;const s=Object.keys(t).reduce(((e,s)=>(e[s]={key:s,name:s,functions:t[s].functions,unit:t[s].unit,fieldType:(0,o.BB)(t[s].unit)},e)),{});h({customMeasurements:s})})).catch((t=>{if(e)return;const s=t?.responseJSON??(0,a.t)("Unable to fetch custom performance metrics");(0,i.Iw)(s),(0,l.Z)(s)(t)})),()=>{e=!0}}),[m,g,s]),(0,c.tZ)(u.z.Provider,{value:p,children:"function"==typeof t?t(p):t})}m.displayName="CustomMeasurementsProvider"},"./app/utils/userselect.tsx":(e,t,s)=>{s.d(t,{l:()=>n});const n=e=>{const t={userSelect:document.body.style.userSelect,MozUserSelect:document.body.style.MozUserSelect,msUserSelect:document.body.style.msUserSelect,webkitUserSelect:document.body.style.webkitUserSelect};return document.body.style.userSelect=e.userSelect||"",document.body.style.MozUserSelect=e.MozUserSelect||"",document.body.style.msUserSelect=e.msUserSelect||"",document.body.style.webkitUserSelect=e.webkitUserSelect||"",t}},"./app/views/discover/table/columnEditCollection.tsx":(e,t,s)=>{s.d(t,{Z:()=>_});var n=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),i=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),o=s("../node_modules/react/index.js"),r=s("../node_modules/react-dom/profiling.js"),a=s("../node_modules/@emotion/react/dist/emotion-react.browser.esm.js"),l=s("./app/components/arithmeticInput/parser.tsx"),d=s("./app/components/button.tsx"),u=s("./app/components/buttonBar.tsx"),c=s("./app/components/charts/styles.tsx"),m=s("./app/components/input.tsx"),g=s("./app/components/performance/waterfall/utils.tsx"),p=s("./app/icons/index.tsx"),h=s("./app/locale.tsx"),f=s("./app/styles/space.tsx"),v=s("./app/utils/analytics.tsx"),b=s("./app/utils/discover/fields.tsx"),x=s("./app/utils/theme.tsx");function y(e,t){const s="nativeEvent"in e?e.nativeEvent:e;return window.TouchEvent&&s instanceof TouchEvent?s.targetTouches[0][t]:s instanceof MouseEvent?s[t]:0}var C=s("./app/utils/userselect.tsx"),w=s("./app/views/dashboards/types.tsx"),S=s("./app/views/dashboards/widgetBuilder/issueWidget/fields.tsx"),D=s("./app/views/dashboards/widgetBuilder/releaseWidget/fields.tsx"),Z=s("./app/views/discover/table/queryField.tsx"),E=s("./app/views/discover/table/types.tsx"),k=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const U="draggable-item";var I;!function(e){e[e.TOP=0]="TOP",e[e.BOTTOM=1]="BOTTOM"}(I||(I={}));class T extends o.Component{constructor(){super(...arguments),(0,n.Z)(this,"state",{isDragging:!1,draggingIndex:void 0,draggingTargetIndex:void 0,draggingGrabbedOffset:void 0,error:new Map,left:void 0,top:void 0}),(0,n.Z)(this,"previousUserSelect",null),(0,n.Z)(this,"portal",null),(0,n.Z)(this,"dragGhostRef",(0,o.createRef)()),(0,n.Z)(this,"handleAddColumn",(()=>{this.props.onChange([...this.props.columns,{kind:"field",field:""}])})),(0,n.Z)(this,"handleAddEquation",(()=>{const{organization:e}=this.props,t={kind:E.L.EQUATION,field:""};(0,v.Gi)("discover_v2.add_equation",{organization:e}),this.props.onChange([...this.props.columns,t])})),(0,n.Z)(this,"handleUpdateColumn",((e,t)=>{const s=[...this.props.columns];"equation"===t.kind?this.setState((s=>{const n=new Map(s.error);return n.set(e,(0,l.W9)(t.field).error),{...s,error:n}})):this.updateEquationFields(s,e,t),s.splice(e,1,t),this.props.onChange(s)})),(0,n.Z)(this,"updateEquationFields",((e,t,s)=>{const n=e[t],i=(0,b.sN)(e[t]),o=(0,b.sN)(s);if((0,b.el)(s)&&!(0,b.bv)(e,n))for(let t=0;t<e.length;t++){const s=e[t];if("equation"===s.kind){const r=(0,l.W9)(s.field);let a="",d=0;const u="function"===n.kind?r.tc.functions:r.tc.fields;for(const e of u)e.term===i&&d!==e.location.end.offset&&(a+=s.field.substring(d,e.location.start.offset)+o,d=e.location.end.offset);a+=s.field.substring(d),e[t]={kind:"equation",field:a,alias:e[t].alias}}}})),(0,n.Z)(this,"onDragMove",(e=>{const{isDragging:t,draggingTargetIndex:s,draggingGrabbedOffset:n}=this.state;if(!t||!["mousemove","touchmove"].includes(e.type))return;e.preventDefault(),e.stopPropagation();const i=y(e,"pageX"),o=y(e,"pageY"),r=n?.x??0,a=n?.y??0;if(this.dragGhostRef.current){const e=this.dragGhostRef.current;e.style.left=i-r+"px",e.style.top=o-a+"px"}const l=document.querySelectorAll(`.${U}`),d=Array.from(l).findIndex((e=>{const t=e.getBoundingClientRect(),s=o,n=window.scrollY+t.top,i=window.scrollY+t.top+t.height;return s>=n&&s<=i}));d>=0&&d!==s&&this.setState({draggingTargetIndex:d})})),(0,n.Z)(this,"isFixedIssueColumn",(e=>{const{source:t,columns:s}=this.props,n=s[e];return s.filter((e=>"field"===e.kind&&e.field===S.Sh.ISSUE)).length<=1&&t===w.l9.ISSUE&&"field"===n.kind&&n.field===S.Sh.ISSUE})),(0,n.Z)(this,"isRemainingReleaseHealthAggregate",(e=>{const{source:t,columns:s}=this.props,n=s[e];return s.filter((e=>e.kind===E.L.FUNCTION)).length<=1&&t===w.l9.RELEASE&&n.kind===E.L.FUNCTION})),(0,n.Z)(this,"onDragEnd",(e=>{if(!this.state.isDragging||!["mouseup","touchend"].includes(e.type))return;const t=this.state.draggingIndex,s=this.state.draggingTargetIndex;if("number"!=typeof t||"number"!=typeof s)return;this.cleanUpListeners(),this.previousUserSelect&&((0,C.l)(this.previousUserSelect),this.previousUserSelect=null);const n=[...this.props.columns],i=n.splice(t,1);n.splice(s,0,i[0]),this.checkColumnErrors(n),this.props.onChange(n),this.setState({isDragging:!1,left:void 0,top:void 0,draggingIndex:void 0,draggingTargetIndex:void 0,draggingGrabbedOffset:void 0})}))}componentDidMount(){if(!this.portal){const e=document.createElement("div");e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.zIndex=String(x.ZP.zIndex.modal),this.portal=e,document.body.appendChild(this.portal)}this.checkColumnErrors(this.props.columns)}componentWillUnmount(){this.portal&&document.body.removeChild(this.portal),this.cleanUpListeners()}checkColumnErrors(e){const t=new Map;for(let s=0;s<e.length;s+=1){const n=e[s];if("equation"===n.kind){const e=(0,l.W9)(n.field);e.error&&t.set(s,e.error)}}this.setState({error:t})}keyForColumn(e,t){return"function"===e.kind?[...e.function,t].join(":"):[...e.field,t].join(":")}cleanUpListeners(){this.state.isDragging&&(window.removeEventListener("mousemove",this.onDragMove),window.removeEventListener("touchmove",this.onDragMove),window.removeEventListener("mouseup",this.onDragEnd),window.removeEventListener("touchend",this.onDragEnd))}removeColumn(e){const t=[...this.props.columns];t.splice(e,1),this.checkColumnErrors(t),this.props.onChange(t)}startDrag(e,t){if(this.state.isDragging||!["mousedown","touchstart"].includes(e.type))return;e.preventDefault(),e.stopPropagation();const s=y(e,"pageY"),n=y(e,"pageX"),i=Array.from(document.querySelectorAll(`.${U}`)).find((t=>t.contains(e.currentTarget))),{x:o,y:r}=(0,g.R3)(i),a={x:n-o+4,y:s-r+4};this.previousUserSelect=(0,C.l)({userSelect:"none",MozUserSelect:"none",msUserSelect:"none",webkitUserSelect:"none"}),window.addEventListener("mousemove",this.onDragMove),window.addEventListener("touchmove",this.onDragMove),window.addEventListener("mouseup",this.onDragEnd),window.addEventListener("touchend",this.onDragEnd),this.setState({isDragging:!0,draggingIndex:t,draggingTargetIndex:t,draggingGrabbedOffset:a,top:s,left:n})}renderGhost(e){let{gridColumns:t,singleColumn:s}=e;const{isDragging:n,draggingIndex:i,draggingGrabbedOffset:o}=this.state,a=i;if("number"!=typeof a||!n||!this.portal)return null;const l=o?.x??0,d=o?.y??0,u=Number(this.state.top)-d,c=Number(this.state.left)-l,m=this.props.columns[a],g={top:`${u}px`,left:`${c}px`},p=(0,k.tZ)(F,{ref:this.dragGhostRef,style:g,children:this.renderItem(m,a,{singleColumn:s,isGhost:!0,gridColumns:t})});return(0,r.createPortal)(p,this.portal)}renderItem(e,t,s){let{singleColumn:n=!1,canDelete:i=!0,canDrag:r=!0,isGhost:a=!1,gridColumns:l=2,disabled:d=!1}=s;const{columns:u,fieldOptions:c,filterAggregateParameters:m,filterPrimaryOptions:g,noFieldsMessage:f,showAliasField:v}=this.props,{isDragging:b,draggingTargetIndex:x,draggingIndex:y}=this.state;let C=null;if(b&&!1===a&&x===t&&(C=(0,k.tZ)(O,{className:U},`placeholder:${this.keyForColumn(e,a)}`)),b&&!1===a&&y===t)return C;const w=Number(x)<=Number(y)?I.TOP:I.BOTTOM;return(0,k.BX)(o.Fragment,{children:[w===I.TOP&&C,(0,k.BX)(A,{showAliasField:v,singleColumn:n,className:a?"":U,children:[r?(0,k.tZ)(R,{"aria-label":(0,h.t)("Drag to reorder"),onMouseDown:e=>this.startDrag(e,t),onTouchStart:e=>this.startDrag(e,t),icon:(0,k.tZ)(p.LS,{size:"xs"}),size:"zero",borderless:!0}):n&&v?null:(0,k.tZ)("span",{}),(0,k.tZ)(Z.q,{fieldOptions:c,gridColumns:l,fieldValue:e,onChange:e=>this.handleUpdateColumn(t,e),error:this.state.error.get(t),takeFocus:t===this.props.columns.length-1,otherColumns:u,shouldRenderTag:!0,disabled:d,filterPrimaryOptions:g,filterAggregateParameters:m,noFieldsMessage:f,skipParameterPlaceholder:v}),v&&(0,k.tZ)(q,{singleColumn:n,children:(0,k.tZ)(j,{name:"alias",placeholder:(0,h.t)("Alias"),value:e.alias??"",onChange:s=>{this.handleUpdateColumn(t,{...e,alias:s.target.value})}})}),i||"equation"===e.kind?v?(0,k.tZ)(N,{"data-test-id":`remove-column-${t}`,"aria-label":(0,h.t)("Remove column"),title:(0,h.t)("Remove column"),onClick:()=>this.removeColumn(t),icon:(0,k.tZ)(p.Fz,{}),borderless:!0}):(0,k.tZ)(N,{"data-test-id":`remove-column-${t}`,"aria-label":(0,h.t)("Remove column"),onClick:()=>this.removeColumn(t),icon:(0,k.tZ)(p.Fz,{}),borderless:!0}):n&&v?null:(0,k.tZ)("span",{})]}),w===I.BOTTOM&&C]},`${t}:${this.keyForColumn(e,a)}`)}render(){const{className:e,columns:t,showAliasField:s,source:n}=this.props,i=t.filter((e=>"equation"!==e.kind)).length>1,o=t.length>1,r=t.length<20,a=r?void 0:(0,h.t)("Sorry, you've reached the maximum number of columns (%d). Delete columns to add more.",20),l=1===t.length,u=n===w.l9.ISSUE?1:Math.max(...t.map((e=>{if("function"!==e.kind)return 2;const t=b.lx[e.function[0]]??D.Am[e.function[0]];return t&&t.parameters?2===t.parameters.length?3:2:3})));return(0,k.BX)("div",{className:e,children:[this.renderGhost({gridColumns:u,singleColumn:l}),!s&&n!==w.l9.ISSUE&&(0,k.tZ)(A,{showAliasField:s,singleColumn:l,children:(0,k.BX)(z,{gridColumns:u,children:[(0,k.tZ)(P,{children:(0,h.t)("Tag / Field / Function")}),(0,k.tZ)(P,{children:(0,h.t)("Field Parameter")})]})}),t.map(((e,t)=>this.isFixedIssueColumn(t)?this.renderItem(e,t,{singleColumn:l,canDelete:!1,canDrag:o,gridColumns:u,disabled:!0}):this.isRemainingReleaseHealthAggregate(t)?this.renderItem(e,t,{singleColumn:l,canDelete:!1,canDrag:o,gridColumns:u}):this.renderItem(e,t,{singleColumn:l,canDelete:i,canDrag:o,gridColumns:u}))),(0,k.tZ)(A,{showAliasField:s,singleColumn:l,children:(0,k.BX)(M,{gap:1,showAliasField:s,children:[(0,k.tZ)(d.zx,{size:"sm","aria-label":(0,h.t)("Add a Column"),onClick:this.handleAddColumn,title:a,disabled:!r,icon:(0,k.tZ)(p.N_,{isCircled:!0,size:"xs"}),children:(0,h.t)("Add a Column")}),n!==w.l9.ISSUE&&n!==w.l9.RELEASE&&(0,k.tZ)(d.zx,{size:"sm","aria-label":(0,h.t)("Add an Equation"),onClick:this.handleAddEquation,title:a,disabled:!r,icon:(0,k.tZ)(p.N_,{isCircled:!0,size:"xs"}),children:(0,h.t)("Add an Equation")})]})})]})}}T.displayName="ColumnEditCollection";const M=(0,i.Z)(u.ZP,{target:"e8eyv779"})("grid-column:",(e=>e.showAliasField?"1/-1":" 2/3"),";justify-content:flex-start;"),A=(0,i.Z)("div",{target:"e8eyv778"})("display:grid;grid-template-columns:",(0,f.D)(3)," 1fr 40px;justify-content:center;align-items:center;width:100%;touch-action:none;padding-bottom:",(0,f.D)(1),";",(e=>e.showAliasField&&(0,a.iv)("align-items:flex-start;grid-template-columns:",e.singleColumn?"1fr":`${(0,f.D)(3)} 1fr 40px`,";@media (min-width: ",e.theme.breakpoints.small,"){grid-template-columns:",e.singleColumn?`1fr calc(200px + ${(0,f.D)(1)})`:`${(0,f.D)(3)} 1fr calc(200px + ${(0,f.D)(1)}) 40px`,";}","")),";"),F=(0,i.Z)("div",{target:"e8eyv777"})("background:",(e=>e.theme.background),";display:block;position:absolute;padding:",4,"px;border-radius:",(e=>e.theme.borderRadius),";box-shadow:0 0 15px rgba(0, 0, 0, 0.15);width:710px;opacity:0.8;cursor:grabbing;padding-right:",(0,f.D)(2),";&>",A,"{padding-bottom:0;}& svg{cursor:grabbing;}"),O=(0,i.Z)("div",{target:"e8eyv776"})("margin:0 ",(0,f.D)(3)," ",(0,f.D)(1)," ",(0,f.D)(3),";border:2px dashed ",(e=>e.theme.border),";border-radius:",(e=>e.theme.borderRadius),";height:",(e=>e.theme.form.md.height),"px;"),z=(0,i.Z)("div",{target:"e8eyv775"})("grid-column:2/3;display:grid;grid-template-columns:repeat(",(e=>e.gridColumns),", 1fr);grid-column-gap:",(0,f.D)(1),";"),P=(0,i.Z)(c.OT,{target:"e8eyv774"})({name:"ti75j2",styles:"margin:0"}),j=(0,i.Z)(m.Z,{target:"e8eyv773"})({name:"jixqcp",styles:"min-width:50px"}),q=(0,i.Z)("div",{target:"e8eyv772"})("margin-top:",(0,f.D)(1),";@media (min-width: ",(e=>e.theme.breakpoints.small),"){margin-top:0;margin-left:",(0,f.D)(1),";}@media (max-width: ",(e=>e.theme.breakpoints.small),"){grid-row:2/2;grid-column:",(e=>e.singleColumn?"1/-1":"2/2"),";}"),N=(0,i.Z)(d.zx,{target:"e8eyv771"})("margin-left:",(0,f.D)(1),";height:",(e=>e.theme.form.md.height),"px;"),R=(0,i.Z)(d.zx,{target:"e8eyv770"})("height:",(e=>e.theme.form.md.height),"px;"),_=T}}]);
//# sourceMappingURL=../sourcemaps/app_utils_customMeasurements_customMeasurementsProvider_tsx-app_views_discover_table_columnEd-d32086.a29be44568bb41e85fbb5cd25867e68b.js.map