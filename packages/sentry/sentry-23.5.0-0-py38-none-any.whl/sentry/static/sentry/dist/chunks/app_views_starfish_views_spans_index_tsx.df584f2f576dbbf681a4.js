(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_views_starfish_views_spans_index_tsx"],{"./app/components/searchBar.tsx":(e,t,n)=>{"use strict";n.d(t,{Z:()=>g,p:()=>_});var a=n("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),s=n("../node_modules/react/index.js"),o=n("./app/components/button.tsx"),i=n("./app/components/inputGroup.tsx"),r=n("./app/icons/index.tsx"),l=n("./app/icons/iconClose.tsx"),d=n("./app/locale.tsx"),c=n("./app/styles/space.tsx"),u=n("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function p(e){let{query:t,defaultQuery:n="",onChange:a,onSearch:o,width:c,size:p,className:g,trailing:y,...b}=e;const f=(0,s.useRef)(null),[v,x]=(0,s.useState)(t??n);(0,s.useEffect)((()=>{"string"==typeof t&&x(t)}),[t]);const j=(0,s.useCallback)((e=>{const{value:t}=e.target;x(t),a?.(t)}),[a]),Z=(0,s.useCallback)((e=>{e.preventDefault(),f.current?.blur(),o?.(v)}),[o,v]),S=(0,s.useCallback)((()=>{x(""),a?.(""),o?.("")}),[a,o]);return(0,u.tZ)(m,{onSubmit:Z,className:g,children:(0,u.BX)(i.BZ,{children:[(0,u.tZ)(i.BZ.LeadingItems,{disablePointerEvents:!0,children:(0,u.tZ)(r.jV,{color:"subText",size:"xs"===p?"xs":"sm"})}),(0,u.tZ)(h,{...b,ref:f,type:"text",name:"query",autoComplete:"off",value:v,onChange:j,width:c,size:p}),(0,u.BX)(i.BZ.TrailingItems,{children:[y,!!v&&(0,u.tZ)(_,{size:"zero",borderless:!0,onClick:S,icon:(0,u.tZ)(l.b,{size:"xs"}),"aria-label":(0,d.t)("Clear")})]})]})})}p.displayName="SearchBar";const m=(0,a.Z)("form",{target:"elu65nr2"})({name:"4bgdod",styles:"display:block;position:relative"}),h=(0,a.Z)(i.BZ.Input,{target:"elu65nr1"})((e=>e.width&&`width: ${e.width};`),";"),_=(0,a.Z)(o.zx,{target:"elu65nr0"})("color:",(e=>e.theme.subText),";padding:",(0,c.D)(.5),";"),g=p},"./app/views/starfish/views/spans/index.tsx":(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>ne});var a=n("./app/components/layouts/thirds.tsx"),s=n("./app/locale.tsx"),o=n("./app/utils/performance/contexts/pageError.tsx"),i=n("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),r=(n("../node_modules/core-js/modules/es.array.at.js"),n("../node_modules/core-js/modules/es.string.at-alternative.js"),n("../node_modules/core-js/modules/es.array.find-last.js"),n("../node_modules/react/index.js")),l=n("../node_modules/@tanstack/react-query/build/lib/useQueries.mjs"),d=n("../node_modules/@tanstack/react-query/build/lib/useQuery.mjs"),c=n("../node_modules/lodash/keyBy.js"),u=n.n(c),p=n("../node_modules/lodash/orderBy.js"),m=n.n(p),h=n("../node_modules/lodash/sumBy.js"),_=n.n(h),g=n("./app/components/datePageFilter.tsx"),y=n("./app/components/searchBar.tsx"),b=n("./app/components/tagDistributionMeter.tsx"),f=n("./app/styles/space.tsx"),v=n("./app/utils/usePageFilters.tsx"),x=n("./app/views/starfish/modules/APIModule/hostDetails.tsx"),j=n("./app/views/starfish/utils/constants.tsx"),Z=n("../node_modules/@emotion/react/dist/emotion-element-6a883da9.browser.esm.js"),S=n("../node_modules/lodash/groupBy.js"),w=n.n(S),k=n("../node_modules/moment/moment.js"),T=n.n(k),$=n("./app/views/starfish/components/chart.tsx"),E=n("./app/views/starfish/components/chartPanel.tsx"),B=n("./app/views/starfish/utils/dates.tsx"),D=n("./app/views/starfish/utils/useSpansQuery.tsx"),N=n("./app/views/starfish/utils/zeroFillSeries.tsx"),C=n("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function O(e){let{descriptionFilter:t,clusters:n}=e;const a=(0,Z.u)(),o=(0,v.Z)(),[i,r,l]=o.selection.datetime.period?.match(B.Pr)??[],d=r&&l?T()().subtract(r,l):T()(o.selection.datetime.start),c=T()(o.selection.datetime.end??void 0),u=n.at(-1),{isLoading:p,data:m}=(0,D.bB)({queryString:`${A(o.selection.datetime,t,u?.grouping_column||"",n.map((e=>e.condition(e.name))))}&referrer=span-time-charts`,initialData:[]});if(!u)return null;const h=w()(m,"primary_group"),_=Object.keys(h).map((e=>{const t=h[e];return(0,N.b)({seriesName:e,data:t.map((e=>({value:e.throughput,name:e.interval})))},T().duration(1,"day"),d,c)})),g=Object.keys(h).map((e=>{const t=h[e];return(0,N.b)({seriesName:e,data:t.map((e=>({value:e.total_time,name:e.interval})))},T().duration(1,"day"),d,c)})),y=Object.keys(h).map((e=>{const t=h[e];return(0,N.b)({seriesName:e,data:t.map((e=>({value:e.p50,name:e.interval})))},T().duration(1,"day"),d,c)}));return(0,C.BX)(L,{children:[(0,C.tZ)(q,{children:(0,C.tZ)(E.Z,{title:(0,s.t)("Total Time"),children:(0,C.tZ)($.Z,{statsPeriod:"24h",height:100,data:g,start:"",end:"",loading:p,utc:!1,grid:{left:"0",right:"0",top:"8px",bottom:"0"},definedAxisTicks:4,stacked:!0,chartColors:a.charts.getColorPalette(2),disableXAxis:!0})})}),(0,C.tZ)(q,{children:(0,C.tZ)(E.Z,{title:(0,s.t)("Throughput"),children:(0,C.tZ)($.Z,{statsPeriod:"24h",height:100,data:_,start:"",end:"",loading:p,utc:!1,grid:{left:"0",right:"0",top:"8px",bottom:"0"},definedAxisTicks:4,stacked:!0,isLineChart:!0,chartColors:a.charts.getColorPalette(2),disableXAxis:!0})})}),(0,C.tZ)(q,{children:(0,C.tZ)(E.Z,{title:(0,s.t)("p50"),children:(0,C.tZ)($.Z,{statsPeriod:"24h",height:100,data:y,start:"",end:"",loading:p,utc:!1,grid:{left:"0",right:"0",top:"8px",bottom:"0"},definedAxisTicks:4,stacked:!0,isLineChart:!0,chartColors:a.charts.getColorPalette(2),disableXAxis:!0})})})]})}O.displayName="SpanTimeCharts";const A=function(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];const{start_timestamp:s,end_timestamp:o}=(0,B.SW)(e),i=a.filter(Boolean);return`SELECT\n    ${n?`${n} AS primary_group,`:""}\n    count() AS throughput,\n    sum(exclusive_time) AS total_time,\n    quantile(0.50)(exclusive_time) AS p50,\n    toStartOfInterval(start_timestamp, INTERVAL 1 DAY) as interval\n    FROM spans_experimental_starfish\n    WHERE greaterOrEquals(start_timestamp, '${s}')\n    ${o?`AND lessOrEquals(start_timestamp, '${o}')`:""}\n    ${i.length>0?"AND":""}\n    ${i.join(" AND ")}\n    ${t?`AND match(lower(description), '${t}')`:""}\n    GROUP BY ${n?"primary_group, ":""} interval\n    ORDER BY interval ASC\n  `},L=(0,i.Z)("div",{target:"e1evs38o1"})("display:flex;flex-direction:row;flex-wrap:wrap;gap:",(0,f.D)(2),";"),q=(0,i.Z)("div",{target:"e1evs38o0"})({name:"82a6rk",styles:"flex:1"}),R={top:{name:"top",label:"All",explanation:"Time Spent",condition:()=>"",grouping_column:"module IN ['db', 'http'] ? concat('top.',  module) : 'top.other'"},"top.db":{name:"top.db",label:"Database",explanation:"Database Operations",description_label:"Query",domain_label:"Table",condition:()=>"module == 'db'",grouping_column:"action IN ['SELECT', 'INSERT'] ? concat('db.',  lower(action)) : 'db.other'"},"db.select":{name:"db.select",label:"SELECT",condition:()=>"action == 'SELECT'"},"db.insert":{name:"db.insert",label:"INSERT",condition:()=>"action == 'INSERT'"},"db.other":{name:"db.other",label:"Other",condition:()=>"action NOT IN ['SELECT', 'INSERT']",grouping_column:"action",grouping_condition:e=>()=>`action == '${e}'`},"top.http":{name:"top.http",label:"HTTP",explanation:"HTTP Server vs. Client",description_label:"URL",domain_label:"Host",condition:()=>"module == 'http'",grouping_column:"concat('http.client.',  lower(action))"},"top.other":{name:"top.other",label:"Other",condition:()=>"module NOT IN ['http', 'db']",grouping_column:"splitByChar('.', span_operation)[1]",grouping_condition:e=>()=>`splitByChar('.', span_operation)[1] = '${e}'`},"http.client.get":{name:"http.client.get",label:"GET",explanation:"Domains",condition:()=>"action == 'GET'",grouping_column:"domain",grouping_condition:e=>()=>`domain = '${e}'`},"http.client.post":{name:"http.client.post",label:"POST",condition:()=>"action == 'POST'"},"http.client.other":{name:"http.client.other",label:"Other",condition:()=>"action NOT IN ['GET', 'POST']"}},I=function(e,t){const n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:[]).filter(Boolean);return`SELECT\n    ${t} AS primary_group,\n    sum(exclusive_time) AS exclusive_time\n    FROM spans_experimental_starfish\n    WHERE 1 = 1\n    ${n.length>0?"AND":""}\n    ${n.join(" AND ")}\n    ${e?`AND match(lower(description), '${e}')`:""}\n    GROUP BY primary_group\n  `},P=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;const{start_timestamp:o,end_timestamp:i}=(0,B.SW)(t),r=n.filter(Boolean);return`SELECT\n    group_id, span_operation, domain, description,\n    sum(exclusive_time) as total_exclusive_time,\n    uniq(transaction) as transactions,\n    quantile(0.50)(exclusive_time) as p50,\n    quantile(0.75)(exclusive_time) as p75\n    FROM spans_experimental_starfish\n    WHERE greaterOrEquals(start_timestamp, '${o}')\n    ${r.length>0?"AND":""}\n    ${r.join(" AND ")}\n    ${i?`AND lessOrEquals(start_timestamp, '${i}')`:""}\n    ${e?`AND match(lower(description), '${e}')`:""}\n    GROUP BY group_id, span_operation, domain, description\n    ORDER BY ${a??"count"} desc\n    ${s?`LIMIT ${s}`:""}`},F=(e,t,n)=>{const{start_timestamp:a,end_timestamp:s}=(0,B.SW)(t);return`\n    SELECT\n    group_id, span_operation,\n    toStartOfInterval(start_timestamp, INTERVAL 1 DAY) as interval,\n    quantile(0.50)(exclusive_time) as percentile_value\n    FROM spans_experimental_starfish\n    WHERE greaterOrEquals(start_timestamp, '${a}')\n    ${s?`AND lessOrEquals(start_timestamp, '${s}')`:""}\n    AND group_id IN (${n.map((e=>`'${e}'`)).join(",")})\n    ${e?`AND match(lower(description), '${e}')`:""}\n    GROUP BY group_id, span_operation, interval\n    ORDER BY interval asc\n  `};n("../node_modules/core-js/modules/es.array.push.js");var z=n("./app/components/duration.tsx"),Y=n("./app/components/gridEditable/index.tsx"),M=n("./app/components/gridEditable/sortLink.tsx"),X=n("./app/components/links/link.tsx"),G=n("./app/constants/chartPalette.tsx"),H=n("./app/views/starfish/components/sparkline.tsx");function W(e){let{location:t,spansData:n,orderBy:a,onSetOrderBy:s,clusters:o,spansTrendsData:i,isLoading:r}=e;const l={};i?.forEach((e=>{let{group_id:t,span_operation:n,interval:a,percentile_value:s}=e;return n in l?t in l[n]?l[n][t].push({name:a,value:s}):l[n][t]=[{name:a,value:s}]:l[n]={[t]:[{name:a,value:s}]}}));const d=n?.map((e=>{const{group_id:t,span_operation:n}=e;if(void 0===l[n])return e;const a={seriesName:"percentile_trend",data:l[n][t]},s=(0,N.b)(a,T().duration(1,"day"));return{...e,percentile_trend:s}}));return(0,C.tZ)(Y.ZP,{isLoading:r,data:d,columnOrder:Q(o),columnSortBy:a?[]:[{key:a,order:"desc"}],grid:{renderHeadCell:U(a,s),renderBodyCell:V},location:t})}function U(e,t){return function(n){return(0,C.tZ)(M.Z,{align:"left",canSort:"percentile_trend"!==n.key,direction:e===n.key?"desc":void 0,onClick:()=>{t(`${n.key}`)},title:n.name,generateSortLink:()=>({...location})})}}function V(e,t){return"percentile_trend"===e.key&&t[e.key]?(0,C.tZ)(H.Z,{color:G.$[3][0],series:t[e.key],width:e.width?e.width-e.width/5:void 0}):"description"===e.key?(0,C.tZ)(K,{children:(0,C.tZ)(X.Z,{to:`/starfish/span/${encodeURIComponent(t.group_id)}`,children:t.description})}):e.key.toString().match(/^p\d\d/)||"total_exclusive_time"===e.key?(0,C.tZ)(z.Z,{seconds:t[e.key]/1e3,fixedDigits:2,abbreviation:!0}):t[e.key]}function Q(e){const t=e.at(1),n=e.findLast((e=>Boolean(e.description_label)))?.description_label||"Description",a=e.findLast((e=>Boolean(e.domain_label)))?.domain_label||"Domain";return[!t&&{key:"span_operation",name:"Operation",width:Y.z7},{key:"description",name:n,width:Y.z7},!!t&&{key:"domain",name:a,width:Y.z7},{key:"total_exclusive_time",name:"Total Time",width:250},{key:"transactions",name:"Transactions",width:Y.z7},{key:"p50",name:"p50",width:Y.z7},{key:"percentile_trend",name:"p50 Trend",width:250}].filter((e=>Boolean(e)))}W.displayName="SpansTable";const K=(0,i.Z)("span",{target:"e5rrkpr0"})({name:"12wal98",styles:"text-overflow:ellipsis;overflow:hidden;white-space:nowrap"}),J=25;function ee(e){const t=(0,v.Z)(),[n,a]=(0,r.useState)({orderBy:"total_exclusive_time"}),[s,o]=(0,r.useState)(""),[i,c]=(0,r.useState)(!1),{orderBy:p}=n,[h,f]=(0,r.useState)(["top"]),Z=h.map((e=>R[e]||{isDynamic:!0,name:e.split(":")[1],value:e.split(":")[1],parentClusterName:e.split(":")[0]})),S=i&&s?`${s}`:void 0,w=Z.at(-1);if(w?.isDynamic){const e=Z.at(-2);w.condition=e?.grouping_condition?.(w.name)||(()=>"")}const k=Z.findLast((e=>!e.isDynamic)),T=(0,l.h)({queries:Z.map((e=>({queryKey:["clusterBreakdown",S,e.name],queryFn:()=>fetch(`${j.M}/?query=${I(S,e.grouping_column||"",Z.map((e=>e.condition(e.name))))}`).then((e=>e.json())),retry:!1,enabled:Boolean(e.grouping_column),initialData:[]})))}),{isLoading:$,data:E}=(0,d.a)({queryKey:["spans",w?.name||"none",S,p],queryFn:()=>fetch(`${j.M}/?query=${P(S,t.selection.datetime,Z.map((e=>e.condition(e.name))),p,J)}`).then((e=>e.json())),retry:!1,initialData:[]}),B=E.map((e=>{let{group_id:t}=e;return t})),{isLoading:D,data:N}=(0,d.a)({queryKey:["spansTrends",w?.name||"none",S],queryFn:()=>fetch(`${j.M}/?query=${F(S,t.selection.datetime,B)}`).then((e=>e.json())),retry:!1,initialData:[],enabled:B.length>0});return(0,C.BX)(r.Fragment,{children:[(0,C.BX)("div",{children:[(0,C.tZ)(te,{children:(0,C.tZ)(g.Z,{alignDropdown:"left"})}),Z.map(((e,t)=>{const n=T[t];if(!n||n.isLoading||n.error)return null;const a=u()(n.data,"primary_group"),s=Object.keys(a),o=m()((s||[]).map((e=>{const t=R[e];return{name:t?.label||e,value:e,count:a[e]?.exclusive_time,url:""}})),"count","desc");return 0===o.length?null:(0,C.tZ)(b.Z,{title:e.explanation||e.label,onTagClick:(e,n)=>{const a=R[n.value],s=Z.at(-1),o=a?n.value:`${s?.name||""}:${n.value}`;f([...h.slice(0,t+1),o])},segments:o,totalValues:_()(o,"count")},e.name)}))]}),(0,C.tZ)("div",{children:(0,C.tZ)("button",{onClick:()=>f(["top"]),children:"Reset"})}),(0,C.tZ)(y.Z,{onChange:e=>{o(e),c(!1)},placeholder:"Search Spans",query:s,onSearch:()=>{c(!0)}}),"http.client.get"===k?.name&&w?.value&&(0,C.tZ)(x.F,{host:w.value}),(0,C.tZ)(O,{descriptionFilter:S||"",clusters:Z}),(0,C.tZ)(W,{location:e.location,clusters:Z,isLoading:$||D,spansData:E,orderBy:p,onSetOrderBy:e=>a({orderBy:e}),spansTrendsData:N})]})}ee.displayName="SpansView";const te=(0,i.Z)("div",{target:"e1ojq8vq0"})("display:flex;flex-direction:row;gap:",(0,f.D)(1),";margin-bottom:",(0,f.D)(2),";");function ne(e){return(0,C.tZ)(a.T3,{children:(0,C.BX)(o.V_,{children:[(0,C.tZ)(a.h4,{children:(0,C.tZ)(a.oB,{children:(0,C.tZ)(a.Dx,{children:(0,s.t)("Spans")})})}),(0,C.tZ)(a.uT,{children:(0,C.BX)(a.or,{fullWidth:!0,children:[(0,C.tZ)(o.YY,{}),(0,C.tZ)(ee,{location:e.location})]})})]})})}ne.displayName="Spans"},"../node_modules/core-js/internals/array-iteration-from-last.js":(e,t,n)=>{var a=n("../node_modules/core-js/internals/function-bind-context.js"),s=n("../node_modules/core-js/internals/indexed-object.js"),o=n("../node_modules/core-js/internals/to-object.js"),i=n("../node_modules/core-js/internals/length-of-array-like.js"),r=function(e){var t=1==e;return function(n,r,l){for(var d,c=o(n),u=s(c),p=a(r,l),m=i(u);m-- >0;)if(p(d=u[m],m,c))switch(e){case 0:return d;case 1:return m}return t?-1:void 0}};e.exports={findLast:r(0),findLastIndex:r(1)}},"../node_modules/core-js/internals/function-bind-context.js":(e,t,n)=>{var a=n("../node_modules/core-js/internals/function-uncurry-this-clause.js"),s=n("../node_modules/core-js/internals/a-callable.js"),o=n("../node_modules/core-js/internals/function-bind-native.js"),i=a(a.bind);e.exports=function(e,t){return s(e),void 0===t?e:o?i(e,t):function(){return e.apply(t,arguments)}}},"../node_modules/core-js/internals/function-uncurry-this-clause.js":(e,t,n)=>{var a=n("../node_modules/core-js/internals/classof-raw.js"),s=n("../node_modules/core-js/internals/function-uncurry-this.js");e.exports=function(e){if("Function"===a(e))return s(e)}},"../node_modules/core-js/modules/es.array.find-last.js":(e,t,n)=>{"use strict";var a=n("../node_modules/core-js/internals/export.js"),s=n("../node_modules/core-js/internals/array-iteration-from-last.js").findLast,o=n("../node_modules/core-js/internals/add-to-unscopables.js");a({target:"Array",proto:!0},{findLast:function(e){return s(this,e,arguments.length>1?arguments[1]:void 0)}}),o("findLast")},"../node_modules/lodash/_baseSum.js":e=>{e.exports=function(e,t){for(var n,a=-1,s=e.length;++a<s;){var o=t(e[a]);void 0!==o&&(n=void 0===n?o:n+o)}return n}},"../node_modules/lodash/sumBy.js":(e,t,n)=>{var a=n("../node_modules/lodash/_baseIteratee.js"),s=n("../node_modules/lodash/_baseSum.js");e.exports=function(e,t){return e&&e.length?s(e,a(t,2)):0}}}]);
//# sourceMappingURL=../sourcemaps/app_views_starfish_views_spans_index_tsx.8828ac2e4d99a6238ab0b029384e0337.js.map