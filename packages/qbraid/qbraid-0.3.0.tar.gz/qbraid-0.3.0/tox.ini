[tox]
envlist = unit-tests, docs, linters
skip_missing_interpreter = true
skipsdist = True

[testenv]
usedevelop = True
basepython = python3
deps = -r{toxinidir}/requirements.txt
passenv =
    JUPYTERHUB_USER
    REFRESH
    AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY
    QISKIT_IBM_TOKEN

[testenv:unit-tests]
description = Run pytests and generate coverage report.
extras = 
    test
commands =
    coverage run -m pytest -x \
                           qbraid/api \
                           qbraid/interface \
                           qbraid/transpiler \
                           qbraid/devices \
                           qbraid/tests \ 
                           -W ignore::DeprecationWarning \
                           -W ignore::PendingDeprecationWarning \
                           -W ignore::urllib3.exceptions.InsecureRequestWarning
    coverage combine
    coverage report --omit=qbraid/transpiler/*/_gate_archive.py,qbraid/transpiler/custom_gates.py
    coverage html
    coverage xml

[testenv:docs]
description = Use sphinx to build the HTML docs.
extras = 
    docs
commands =
    sphinx-build -W -b html docs/ docs/build/html {posargs}

[testenv:isort]
envdir = .tox/linters
skip_install = true
deps = isort
commands = 
    isort . {posargs} qbraid/api \               
                      qbraid/interface \
                      qbraid/transpiler \
                      qbraid/devices

[testenv:pylint]
envdir = .tox/linters
skip_install = true
deps = pylint
commands = 
    pylint {posargs} qbraid/__init__.py \
                     qbraid/_qprogram.py \
                     qbraid/_warnings.py \
                     qbraid/exceptions.py \
                     qbraid/display_utils.py \
                     qbraid/wrappers.py \
                     qbraid/get_devices.py \
                     qbraid/get_jobs.py \
                     qbraid/tests \
                     qbraid/api \
                     qbraid/interface \
                     qbraid/transpiler \
                     qbraid/devices \
                     --exit-zero \
                     --disable=C0103,E0401,R0801,R0902,R0903,R0911,R0912,R0914,W0212,W0511
                    

[testenv:black]
envdir = .tox/linters
skip_install = true
deps = black
commands = 
    black {posargs} qbraid --exclude /(qbraid/transpiler/cirq_pytket/tests/test_from_pytket.py|qbraid/transpiler/cirq_qasm)/

[testenv:linters]
envdir = .tox/linters
skip_install = true
deps =
    {[testenv:isort]deps}
    {[testenv:pylint]deps}
    {[testenv:black]deps}
commands =
    {[testenv:isort]commands}
    {[testenv:pylint]commands}
    {[testenv:black]commands}
    python tools/verify_headers.py qbraid
